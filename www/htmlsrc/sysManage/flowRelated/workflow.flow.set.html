<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>流程配置</title>
    <script src="../../../static/vendor/jquery/jquery.js"></script>
    <script src="/static/vendor/layui/layer/layer.js"></script>
    <script src="../../../static/vendor/artTemplate/template-web.js"></script>
    <script src="../../../static/htmljs/global.config.js"></script>
    <script src="/static/htmljs/utils.js"></script>
    <script src="../../../tmpl/js/panelForm.js"></script>
    <script src="../../../static/vendor/validate/jquery.validate.min.js"></script>
    <link href="../../../static/vendor/bootcss/css/bootstrap.min.css" rel="stylesheet">
    <script src="../../../static/htmljs/GooFlow.js"></script>
    <link rel="stylesheet" href="../../../static/htmlcss/gooflow.css">
    <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
</head>
<body>
<div id="demo" style="margin:10px"></div>
<div class="node-dialog" style="display: none;padding: 20px;">
    <p>
        节点名 <b class="node-name"></b>
    </p>
    <div>
        节点类型
        <label>
            <input type="radio" name="node-type" class="node-type" value="start">
            开始节点
        </label>
        <label>
            <input type="radio" name="node-type" class="node-type" value="end">
            结束节点
        </label>
        <label>
            <input type="radio" name="node-type" class="node-type" value="process">
            过程节点
        </label>
    </div>
    <div>
        节点最大处理人数 <input type="text" class="node-max-persons"/>
    </div>
    <div class="fields">
        必填字段 <button class="set-fields" data-type="required">设置</button>
        <div class="field-list" style="min-height:100px">
        </div>
    </div>
    <div class="fields">
        选填字段 <button class="set-fields" data-type="optional">设置</button>
        <div class="field-list" style="min-height:100px">
        </div>
    </div>
    <div>
        <label>
            <input type="checkbox" class="node-allow-upload">
            是否允许上传文件
        </label>
    </div>
</div>
<div class="line-dialog" style="padding: 20px;display: none;">
    <div>
        <label>
            <input type="radio" name="line-type" class="line-type" value="manual">
            不使用触发条件
        </label>
        <label>
            <input type="radio" name="line-type" class="line-type" value="node">
            使用本节点属性
        </label>
    </div>
    <div class="line-condition-list">
        有<input type="text" class="node-person-count" style="width: 30px"/>个人填写的
        <input type="text" readonly class="node-field-name">字段的值
        <select class="node-field-op">
            <option value="=">=</option>
            <!--暂时没有别的-->
            <!--<option value="">></option>-->
            <!--<option value=""><</option>-->
            <!--<option value="">>=</option>-->
            <!--<option value=""><=</option>-->
        </select>
        值
        <input type="text" class="node-field-value" style="width: 100px;">
    </div>
</div>
<script id="fields-model-item" type="text/html">
    {{ each fields field index }}
        <label style="display: block;" class="field-label">
            <input type="checkbox" value="{{field.name}}">
            {{field.name}}
        </label>
    {{ /each }}
</script>
<div class="fields-model" style="display: none; padding: 20px;">
    <div class="field-list">
    </div>
    <button class="btn-confirm">确定</button>
</div>
<div class="line-fields-model">
    <div class="field-list"></div>
</div>
<script>

    var modelId = getParam("id");

    //获取
    getRemoteData({
        url: remoteApi.apiWorkflowModelGetFields+"?modelId="+modelId,
        callback: function(data){
            if(data && data.length){
                console.log(data)
                renderFieldsModel({
                    fields: data
                })
            }
        }
    });


    //main
    $(document).ready(function(){
        var property={
            width:1200,
            height:600,
            toolBtns:["start round","end","task","node","chat","state","plug","join","fork","complex mix"],
            haveHead:true,
            headBtns:["reload","edit-node fa fa-book"],//如果haveHead=true，则定义HEAD区的按钮
            haveTool:true,
            haveGroup:true,
            useOperStack:true
        };
        var remark={
            cursor:"选择指针",
            direct:"转换连线",
            start:"开始结点",
            "end round":"结束结点",
            "task round":"任务结点",
            node:"自动结点",
            chat:"决策结点",
            state:"状态结点",
            plug:"附加插件",
            fork:"分支结点",
            "join":"联合结点",
            "complex mix":"复合结点",
            group:"组织划分框编辑开关"
        };

        window.demo = demo =$.createGooFlow($("#demo"),property);
        demo.setNodeRemarks(remark);
        demo.onBtnEditNodeClick = onBtnEditNodeClick
        demo.onLineEditClick = onLineEditClick
    });

    //事件
    /**
     * 节点属性编辑
     * @returns {*|void}
     */
    function onBtnEditNodeClick() {
        var node = $(".GooFlow_item.item_focus");
        if(node.length == 0){
            return layer.msg("没有选择对应的节点");
        }
        var id = node[0].id;
        var nodeData = getNodeData(id)
        if(!nodeData){
            return layer.msg("没有选择对应的节点")
        }

        layer.open({
            type: 1,
            content: $(".node-dialog")
        });

        //清空
        $(".node-dialog").data("bind-id", id)
        $(".node-name").html(nodeData.name)
        $(".node-type").prop("checked",false)
        $(".node-type[value="+nodeData.ext.type+"]").prop("checked",true)
        $(".node-max-persons").val(nodeData.ext.maxPersons)
        var chkAllowUpload = $(".node-allow-upload")
        chkAllowUpload.prop("checked",nodeData.ext.allowUpload)
        $(".field-list").html("");
        //必填字段填充
        nodeData.ext.requiredFields.forEach(function (value) {
            renderFieldListItem($(".field-list").eq(0),value)
        })
        nodeData.ext.optionalFields.forEach(function (value) {
            renderFieldListItem($(".field-list").eq(1), value)
        })
        //反向绑定
        $(".node-type").each(function () {
            $(this).closest("label")[0].onclick = function (e) {
                if (!e) e = window.event;
                nodeData.ext.type = e.target.value;
            }
        })
        $(".node-max-persons")[0].onchange = function(e){
            if (!e) e = window.event;
            var val  = e.target.value
            //是整数才通过
            if(parseInt(val) == val){
                nodeData.ext.maxPersons = val
            }
        }
        chkAllowUpload.closest("label")[0].onclick = function () {
            nodeData.ext.allowUpload = chkAllowUpload[0].checked
        }


        //设置按钮事件
        $(".set-fields").each(function () {
            this.onclick = function () {
                var box = $(this).closest(".fields").find(".field-list");
                var type = $(this).data("type")
                //重置字段
                $(".fields-model :checked").prop("checked",false)
                $(".fields-model input[type=checkbox]").filter(function () {
                    if(type == "required"){
                        return nodeData.ext.requiredFields.indexOf(this.value) > -1
                    }
                    else{
                        return nodeData.ext.optionalFields.indexOf(this.value) > -1
                    }
                }).prop("checked",true)
                layer.open({
                    type:1,
                    content: $(".fields-model"),
                    cancel : function () {
                        box.html("")
                        var fields;
                        if(type == "required"){
                            fields = nodeData.ext.requiredFields = []
                        }
                        else{
                            fields = nodeData.ext.optionalFields = []
                        }
                        $(".field-label input:checked").each(function () {
                            renderFieldListItem(box,this.value)
                            fields.push(this.value)
                        })
                    }
                })
            }
        })
    }

    /**
     * 节点走向属性编辑
     * @param id
     * @returns {*|void}
     */
    function onLineEditClick(id) {
        var lineData = getLineData(id)
        if(null == lineData){
            return layer.msg("找不到对应的连线")
        }

        layer.open({
            type: 1,
            content: $(".line-dialog")
        })

        $(".line-type").each(function () {
            $(this).closest("label")[0].onclick = function () {
                var val = $(".line-type:checked").val()
                if(val == "manual"){
                    $(".line-condition-list").hide()
                }
                else{
                    $(".line-condition-list").show()
                }
                lineData.ext.type = val
            }
        })

        //初始化
        $(".line-type").prop("checked",false)
        $(".line-type[value="+lineData.ext.type+"]").prop("checked",true).click()
    }

    //函数
    function distinct(arr){
        var obj = {}
       for(var i = 0; i < arr.length; i++){
            obj[arr[i]] = 1
       }
       var ret = []
       for(var i in obj){
            ret.push(i)
       }
       return ret
    }
    function renderFieldsModel(data) {
        var model = $(".fields-model")
        var html = template("fields-model-item",data)
        model.html(html)
    }
    function getNodeData(id) {
        var nodeData = demo.$nodeData[id]
        if(null != nodeData){
            assertNodeData(nodeData)
        }
        return nodeData
    }
    function getLineData(id) {
        var lineData = demo.$lineData[id]
        if(null != lineData){
            assertLineData(lineData)
        }
        return lineData
    }
    function assertLineData(lineData) {
        lineData.ext = lineData.ext || {}
        lineData.ext.type = lineData.ext.type || "manual"
    }
    function assertNodeData(nodeData) {
        nodeData.ext = nodeData.ext || {}
        nodeData.ext.type = nodeData.ext.type || "process"
        nodeData.ext.requiredFields = nodeData.ext.requiredFields || []
        nodeData.ext.optionalFields = nodeData.ext.optionalFields || []
        nodeData.ext.maxPersons = nodeData.ext.maxPersons || 1
        nodeData.ext.allowUpload = nodeData.ext.allowUpload || false
    }
    function renderFieldListItem(box,value) {
        $("<p>"+value+"</p>").appendTo(box)
    }
</script>
</body>
</html>