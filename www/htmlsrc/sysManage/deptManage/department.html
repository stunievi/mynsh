<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>系统管理 - 部门管理</title>
    <link rel="stylesheet" href="/static/vendor/bootcss/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/vendor/ztree/css/zTreeStyle/zTreeStyle.css" type="text/css">
    <link rel="stylesheet" href="/static/htmlcss/style.css">
    <!-- <script src="../../../static/vendor/artTemplate/template-web.js"></script> -->
</head>
<body>
    <div id="content">
        <div class="panel panel-default">
            <div class="panel-heading"> 部门列表 </div>
            <div class="panel-body">
                <div class="col-md-6 col-xs-12">
                    <div class="panel panel-default">
                        <div class="panel-heading"> 部门列表 <a class="btn btn-xs btn-success pull-right" id="addTopDept" href="javascript:;">添加顶级部门</a> </div>
                        <!-- <input class="form-control input-sm" type="text" id="key" placeholder="请输入筛选关键词" style="width:30%;margin-top:6px;"> -->
                        <div id="dataTree" class="ztree">
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-xs-12">
                    <div class="panel panel-default">
                        <div class="panel-heading"> 人员列表 </div>
                        <div class="panel-body">
                            <ul class="list-group" id="dataList">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="../../../static/vendor/jquery/jquery.js"></script>
    <script src="/static/vendor/layui/layer/layer.js"></script>
    <script type="text/javascript" src="/static/vendor/ztree/js/jquery.ztree.core.js"></script>
    <script type="text/javascript" src="/static/vendor/ztree/js/jquery.ztree.excheck.min.js"></script>
    <script type="text/javascript" src="/static/vendor/ztree/js/jquery.ztree.exedit.min.js"></script>
    <!-- <script type="text/javascript" src="/static/vendor/ztree/js/jquery.ztree.exhide.min.js"></script> -->
	<!-- <script type="text/javascript" src="/static/vendor/ztree/js/fuzzysearch.js"></script> -->
    <script src="../../../static/vendor/artTemplate/template-web.js"></script>
    <script src="/static/vendor/bootcss/js/bootstrap.min.js"></script>
    <script src="/tmpl/js/panelForm.js"></script>


    <script src="/static/vendor/validate/jquery.validate.min.js"></script>
    <script src="/static/htmljs/global.config.js"></script>
    <script src="/static/htmljs/utils.js"></script>

    <script id="tmpl" type="text/html">
        {{ if dataList.length > 0}}
            {{ each dataList quarter }}
            <li href="javascript:" class="list-group-item"  style="overflow: hidden">
                <a  title="{{quarter.name}}" style="max-width: 270px; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; float: left;color: #000;">{{quarter.name}}</a>
                <a class="btn btn-default btn-xs pull-right handleEditPerson" data-id="{{quarter.id}}" data-qname="{{quarter.name}}" style="margin-left: 8px;">人员</a>
                <!-- <a class="btn btn-danger btn-xs pull-right" data-id="{{quarter.id}}" style="margin-left: 8px;" delete-href="{{remoteOrigin}}/api/auto/org/delete?id={{quarter.id}}">删除</a>
                <a class="btn btn-warning btn-xs pull-right " data-index="{{$index}}" href="javascript:;" data-id="{{quarter.id}}" tab-href="/htmlsrc/sysManage/quartersManage/quarters.edit.html?qid={{quarter.id}}">编辑</a> -->
                <div class="panel-body user-list" >
                    <ul class="list-group">
                            <div class="col-xs-12" style='margin-top: 10px;' id="list-{{quarter.id}}">
                                    <!-- <div id="personList"> -->
                                        <!-- 用户列表 -->
                                    <!-- </div> -->
                                    <!--<div class="panel panel-default">-->
                                        <!--<div class="panel-heading">-->
                                            <!--人员列表-->
                                        <!--</div>-->
                                        <!--<div class="panel-body">-->
                                            <!---->
                                        <!--</div>-->
                                    <!--</div>-->
                                </div>
                    </ul>
                </div>
            </li>
            {{ /each }}
        {{else}}
            该部门下无岗位
        {{/if}}
    </script>


    <SCRIPT type="text/javascript">
    // 部门树设置
		var setting = {
			view: {
				addHoverDom: addHoverDom,
				removeHoverDom: removeHoverDom,
                selectedMulti: false,
                showLine: false
			},
			edit: {
				enable: true,
				showRemoveBtn: true,
				showRenameBtn: true
			},
			data: { simpleData: { enable: true } },
			callback: {
				beforeDrag: function(){ return false },
				beforeEditName: beforeEditName,
				beforeRemove: beforeRemove,
                onClick: switchDept
			}
        };
        var ZTREE = null;


        var deptId; // 选中部门Id
        var deptName; // 选中部门name
        var deptQuarters = [];

        function onInfront(){
            // 渲染数据列表
            getFetch(
                // loading: true,
                // url: remoteApi.apiAlldepartment,
                remoteOrigin + "/api/auto/org/getDList"
                , function(origin){
                    top.topCacheDepartment = origin;
                    $.fn.zTree.init($("#dataTree"), setting, origin);
                    var zTree = ZTREE = $.fn.zTree.getZTreeObj("dataTree")
                    zTree.expandAll(true);
                    // 默认点击 展开人员列表
                    $("#dataTree_2_a").click()
                    // fuzzySearch('dataTree','#key',null,true); //初始化模糊搜索方法
                }
            )
            showQs(deptId);
        }
        onInfront();
        // showQs();

        function showQs(pid) {
            $("#dataList").html("");
            getFetch(remoteOrigin + "/api/user/org/getQList", {pid: pid}, function (deptQuarters) {
                console.log(deptQuarters)
                $("#dataList").html(template('tmpl', {
                    dataList: deptQuarters
                }));
                for(var i = 0; i < deptQuarters.length; i++){
                    oninit(deptQuarters[i].id)
                }
            })
        }

        // 切换部门展示岗位
        function switchDept(event, treeId, treeNode, clickFlag){
            deptId = treeNode.id;
            deptName = treeNode.name;
            showQs(deptId);


            // deptQuarters = treeNode.quarters;
            // deptQuarters.sort(function(a, b){
            //     return a.sort > b.sort;
            // })
            // $("#dataList").html(template('tmpl', {
            //     dataList: deptQuarters
            // }));
        }
        function oninit(oid){
            console.log(oid)
            laytableRender({
                url: remoteOrigin + "/api/auto/user/getList?onlyO=1&ooid=" + oid,
                id:'list-' + oid,
                cols: [
                    [
                        {field:'trueName', title: '姓名'},
                        {field:'username', title: '用户名'},
                        {field:'phone', title: '电话'}
                        // {title:'操作', templet: '#toolbar'}
                    ]
                ]
            });
        }
        eventBind(".handleEditPerson", function(that){
            top.addTab("dep-add-" + top.getCountDown(), "编辑岗位人员-" + that.data("qname"), "/htmlsrc/sysManage/quartersManage/quarters.users.html?id="+that.data("id"));
            // layerOpenIframe({
            //     title: "编辑岗位人员 - " + that.data("qname"),
            //     url: "./quarters.users.html?id="+that.data("id")
            // })
        })

        // 编辑部门
		function beforeEditName(treeId, treeNode) {
            top.addTab("dep-add-" + top.getCountDown(), "编辑部门", "/htmlsrc/sysManage/deptManage/department.edit.html?id="+treeNode.id);
			return false;
        }
        // 编辑回调
        function editDeptCallback(origin){
            var zTree = $.fn.zTree.getZTreeObj("dataTree");
            editNode.name = origin.name;
            var edited = editNode.sort != origin.sort;
            editNode.sort = origin.sort;
            zTree.editName(editNode);
            zTree.cancelEditName(); // 取消编辑状态
            layer.close(editNodeIndex);
            if(edited){
                var dom = $('#' + editNode.tId);
                dom.parent().append(dom.parent().children().toArray().sort(function(a,b){
                    var doma = ZTREE.getNodeByTId(a.id);
                    var domb = ZTREE.getNodeByTId(b.id);
                    if(doma.sort - domb.sort == 0){
                        return doma.id - domb.id
                    }else{
                        return doma.sort - domb.sort
                    }
                }))
            }
            layer.msg("编辑成功!");
        }
        // 删除
		function beforeRemove(treeId, treeNode) {
			var zTree = $.fn.zTree.getZTreeObj("dataTree");
			actConfirm(function () {
                getFetch(remoteOrigin + "/api/user/org/delete", {id: treeNode.id}, function () {
                    zTree.removeNode(treeNode);
                    layer.msg("已删除");
                })
            });
			// getFetch()
            // delRemoteData({
            //     url: remoteApi.apiDepartment+"?departmentId="+treeNode.id,
            //     callback: function(){
            //         zTree.removeNode(treeNode);
            //         layer.msg("已删除");
            //     }
            // });
			return false;
        }
        // 添加添加部门按钮
		function addHoverDom(treeId, treeNode) {
		    var id = treeNode.id + "";
			var sObj = $("#" + treeNode.tId + "_span");
			if (treeNode.editNameFlag || $("#addBtn_"+treeNode.tId).length>0) return;
			var addStr = "<span class='button add' id='addBtn_" + treeNode.tId
				+ "' title='add node' onfocus='this.blur();'></span>";
			sObj.after(addStr);
			var btn = $("#addBtn_"+treeNode.tId);
			if (btn) btn.bind("click", function(){
                // 添加部门
                $("<button type='button' style='display: none'></button>")
                    .attr({
                        "tab-title": "添加部门"
                        , "tab-href": "/htmlsrc/sysManage/deptManage/department.add.html?pid=" + treeNode.id+"&pname="+treeNode.name
                    })
                    .appendTo("body")
                    .trigger("click")
                    .remove();

                currAddDept = treeNode;
                // addDeptIndex = layerOpenIframe({
                //     title: "添加部门",
                //     url:  "./department.add.html?pid="+treeNode.id+"&pname="+treeNode.name
                // })
				return false;
			});
        };
        // onmouseleave移除功能按钮
		function removeHoverDom(treeId, treeNode) {
			$("#addBtn_"+treeNode.tId).unbind().remove();
        };
        // 添加顶级部门
        eventBind("#addTopDept", function(){
            currAddDept = null;
            top.addTab("dep-add-" + top.getCountDown(), "添加部门", "/htmlsrc/sysManage/deptManage/department.add.html?pid=0&pname=顶级部门");
        })
        // 添加部门回调
        function addDeptCallback(origin){
            var zTree = $.fn.zTree.getZTreeObj("dataTree");
            zTree.addNodes(currAddDept, origin);
            layer.close(addDeptIndex);
        }
    </SCRIPT>
</body>
</html>