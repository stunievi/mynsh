<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title> 绑定表单</title>
    <!--#include file="/htmlsrc/header.html" -->
    <!--<script src="/static/vendor/bootcss/js/bootstrap-suggest.js"></script>-->
    <link rel="stylesheet" href="/static/vendor/ztree/css/zTreeStyle/zTreeStyle.css">
    <script src="/static/vendor/ztree/js/jquery.ztree.all.min.js"></script>
    <script src="/static/vendor/bootcss/js/bootstrap-suggest.js"></script>
    <style>
        #content{
            overflow: visible;
        }
        .dropdown-menu-right{
            left: 0 !important;
        }
    </style>
</head>
<body>
    <div id="content">

        <div id="addUserForm" class="col-xs-12" style="padding-bottom: 20px;padding-top:10px;">
            <form name="binding-form" class="form-horizontal" onsubmit="return checkSubmitForm(this)" novalidate="novalidate">
                <div class="row panel-form-input-group">

                    <div class="col-xs-6 form-group ">
                        <!--<label class="col-xs-4 text-right"><span style="color:red">*</span>  审批人类型 </label>
                        <div class="col-xs-8">
                            <select class="form-control input-sm" id="taskType" name="taskType" value="0">
                                <option value="post">岗位</option>
                                <option value="role">角色</option>
                                <option value="dept">部门</option>
                                <option value="uid">人员</option>
                            </select>
                        </div>
                         <div class="col-xs-12 form-group " data-show="">
                            <label class="col-xs-3 text-right">
                                岗位
                            </label>
                            <div class="col-xs-8" style="padding-right: 15px;
                        padding-left: 15px; max-width:400px">
                                <input type="text" class="form-control input-sm" id="quarters" name="quarters">
                            </div>
                        </div>
                        <div class="col-xs-12 form-group " data-show="">
                             <label class="col-xs-3 text-right">
                                 角色
                             </label>
                             <div class="col-xs-8" style="padding-right: 15px;
                         padding-left: 15px; max-width:400px">
                                 <input type="text" class="form-control input-sm" id="role" name="role">
                             </div>
                         </div>
                         <div class="col-xs-12 form-group " data-show="">
                             <label class="col-xs-3 text-right">
                                 部门
                             </label>
                             <div class="col-xs-8" style="padding-right: 15px;
                         padding-left: 15px; max-width:400px">
                                 <input type="text" class="form-control input-sm" id="dept" name="dept">
                             </div>
                         </div>
                         <div class="col-xs-12 form-group " data-show="">
                             <label class="col-xs-3 text-right">
                                 人员
                             </label>
                             <div class="col-xs-8" style="padding-right: 15px;
                         padding-left: 15px; max-width:400px">
                                 <input type="text" class="form-control input-sm" id="uid" name="uid">
                             </div>
                         </div>-->
                    </div>

                </div>
                <hr>

                <div class="cols-xs-12">
                    <div class="col-xs-12 col-sm-6 cPost" >
                        <h5>选择岗位</h5>
                        <hr>
                        <ul id="treeDemo" class="ztree"></ul>
                    </div>
                    <div class="col-xs-12 col-sm-6 cPost" >
                        <h5>选择部门</h5>
                        <hr>
                        <ul id="treeDemo1" class="ztree"></ul>
                    </div>

                    <div class="col-xs-12 col-sm-6 cRole">
                        <h5>选择角色</h5>
                        <hr>
                        <div id="dataList"></div>
                    </div>
                    <div class="col-xs-12 col-sm-6">
                        <h5>表单</h5>
                        <hr>
                        <div id="formList"></div>
                    </div>

                    <div class="col-xs-12 col-md-6" style="margin-bottom: 10px;">
                        <div class="form-group">
                            <label>输入想要查询的人员并选择, 按tab添加全部, 如需多个关键字, 使用逗号分隔</label>
                            <input type="text" class="form-control" id="suggest" value="" disabled>
                            <div class="input-group-btn">
                                <ul class="dropdown-menu dropdown-menu-right" role="menu">
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-12">
                        <div id="dataList1">
                            <!-- 用户列表 -->
                        </div>
                    </div>
                </div>

                <!--<div class="col-xs-12">-->
                    <!--<div class="col-xs-12 col-md-6" style="margin-bottom: 10px;">-->
                        <!--<div class="form-group">-->
                            <!--<label for="">输入想要查询的岗位/角色并选择, 按回车键添加当前选择, 按tab添加全部, 如需多个关键字, 使用逗号分隔</label>-->
                            <!--<input type="text" class="form-control" id="suggest" value="" disabled>-->
                            <!--<div class="input-group-btn">-->
                                <!--&lt;!&ndash;<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">&ndash;&gt;-->
                                <!--&lt;!&ndash;<span class="caret"></span>&ndash;&gt;-->
                                <!--&lt;!&ndash;</button>&ndash;&gt;-->
                                <!--<ul class="dropdown-menu dropdown-menu-right" role="menu">-->
                                <!--</ul>-->
                            <!--</div>-->
                        <!--</div>-->
                        <!--&lt;!&ndash; /btn-group &ndash;&gt;-->
                        <!--&lt;!&ndash;<input type="text" class="form-control" id="suggest">&ndash;&gt;-->
                    <!--</div>-->
                    <!--<div class="col-xs-12 col-md-6" style="margin-bottom: 10px;">-->
                        <!--<div class="" id="dataList">-->

                        <!--</div>-->
                    <!--</div>-->

                <!--</div>-->
                <div class="col-xs-12 text-center" style="padding-top: 15px;">
                    <button id="saveForm" type="submit" class="btn-save btn btn-primary"><i class="glyphicon glyphicon-ok"></i> 确定</button>
                </div>
            </form>
        </div>
    </div>

    <script type="text/html" id="userToolbar">
        <div class="layui-toolbar">
            <button data-name="{{d.word}}" data-id="{{d.id}}" class="btn btn-danger btn-sm btn-remove">删除</button>
        </div>
    </script>

    <script type="text/html" id="model_temp">
        <table id="formData">
            <tr >
                <td>字段名</td>
            </tr>
            {{each formList value index}}
            <tr>
                <td><input class="formInfo" type="checkbox" name="list" value="{{value.name}}"><span>{{value.title}}</span><span class="hide">{{value.type}}</span></td>
            </tr>
            {{/each}}
        </table>
    </script>
    <script>

        var setting = {
            view: {
                addHoverDom: false,
                removeHoverDom: false,
                selectedMulti: false
            },
            check: {
                enable: true
            },
            data: {
                simpleData: {
                    enable: true
                }
            },
            edit: {
                enable: false
            }
        };
        var quarterArr = [];
        var deptArr = [];
        var roleArr = [];
        var taskId = getParam("taskId");
        var modelName = getParam("name");
        var formId = getParam("formId");
        var formList = [];
        var selected = [];
        var items = [];

        $.ajax({
            type:"get",
            url:"/bpm/form/queryFormData?_id="+formId,
            async:false,
            success:function(data){
                var list = data.data[0].form.data;
                console.log(">>>>",data.data[0].form.data)
                for (var i = 0; i < list.length; i++) {
                    formList.push({"name":list[i].name,"title":list[i].title,"type":list[i].type})
                }
            }
        });
        $("#formList").html(
            template("model_temp",{
                formList:formList
            })
        );
        var p1 = getFetch(remoteOrigin + "/api/auto/user/getList?page=1&size=2000")
        $.when(p1).then(function (a,b,c) {
            var d1 = a.data.list;
            var ret = {value:[]}
            sourceData = ret.value = $.map(d1 || [], function (v) {
                return {word: v.trueName, id: v.id}
                // return {word: (v.type == "QUARTERS" ? "[岗位]" : "[角色]") + "" + v.fullName}
            });
           /* var items = $.map(d2 || [], function (v) {
                return {word: v.oname, id: v.id}
            })*/
            addItems(items)
            onload()
        });

        function onload(){
            $("#suggest").bsSuggest({
                // url: remoteOrigin + "/api/user/org/getDQList"
                data: {
                    value: sourceData
                }
                , allowNoKeyword: false
                , multiWord: true
                , separator: " "
                , twoWayMatch: false
                // , getDataMethod: "url"
                // , jsonp: "callback"
                , delay: 100
                // , clearable: true

                //     fnProcessData: function (data) {
                //     if(!data.success || !data.data || !data.data.length){
                //         return false
                //     }
                //
                //     addItems([])
                //     return ret;
                //     // console.log(data)
                // }
            });

        }
        function addItems(items) {
            $.each(items, function (i,v) {
                selected.push(v);
            });
            // selected = selected.reverse()
            var map = {};
            $.each(selected,function (i,v) {
                if(!v.word){
                    return;
                }
                //过滤不需要的
                var target = $.grep(sourceData, function (vv) {
                    return vv.word == v.word
                });
                if(!target.length){
                    return;
                }
                map[v.word] = target[0].id+"," +target[0].word;;
            });
            selected = [];
            console.log(map);
            for(var key in map){
                console.log(key)
                console.log(map[key])
                selected.push({word:key,id:map[key]});
            }
            $("#dataList1").empty();
            laytableRender({
                id: 'dataList1',
                page: false,
                cols:[
                    [
                        {title:"姓名", field:"word"}
                        , {title:"操作", templet:"#userToolbar"}
                    ]
                ]
                , data : selected
            });
        }
        var temp = null;
        function beforeSuggest(p) {
            if(p.length > 0){
                temp = $.extend({}, p);
                // p.unshift({word:"[全部]" + $('#suggest').val()})
            }
        }
        $("#suggest").on("keydown", function (e) {
            // console.log(e.keyCode)
            // if(e.keyCode != 13){
            //    return;
            // }
            var val = $.trim($(this).val());
            if(e.keyCode == 9 && null != temp){
                addItems(temp);
                temp = null;
                $(this).val("")
            }
            else if(e.keyCode == 13){
                addItems([{word:val}])
                $(this).val("")
            }
        });
        $(document).on("click", ".btn-remove", function(){
            var name = $(this).data('name');
            selected = $.grep(selected, function (v) {
                return v.word != name;
            });
            addItems([])
        });
        $(document).on("mousedown", ".dropdown-menu tr", function () {
            setTimeout(function () {
                var val = $.trim($("#suggest").val());
                addItems([{word:val}])
                $("#suggest").val("")
            },50)
        });


        var fulldata = null;
        var nodeId = -1;
        function onPageRequest(data){
            fulldata = data.data;
            nodeId = data.nodeId;

            // if(fulldata && fulldata.ext[nodeId]){
            //     //还原页面
            // }
            var ext = data.data.ext;
            var _startEvent = data.data.startEvent;
            console.log("还原页面值：",fulldata)
            for(var i=0;i<ext.length;i++){

                console.log("当前节点是否已经有值：",ext[i].taskId == nodeId)
                if(ext[i].taskId == nodeId && fulldata){


                    dataId = fulldata.ext[i].dataId.split(",");
                    roleArr = fulldata.ext[i].role.split(",");
                    deptArr = fulldata.ext[i].dept.split(",");
                    quarterArr = fulldata.ext[i].quarters.split(",");


                    // 表单赋值
                    for(var j=0;j<dataId.length;j++){

                        $("input:checkbox[name='list']").each(function(){
                            if($(this).val()==dataId[j]){
                                $(this).attr("checked","checked");
                            }
                        })
                    }
                    // 角色

                    // 部门赋值
                    $.fn.zTree.init($("#treeDemo1"), setting, data);


                    // 岗位赋值
                    $.fn.zTree.init($("#treeDemo"), setting, data);
                    /*var treeObj = $.fn.zTree.getZTreeObj("treeDemo");

                    for(var i=0;i<quarterArr.length;i++){
                        var node = treeObj.getNodeByParam("id", quarterArr[i], null)
                        if(null != node){
                            treeObj.checkNode(node, true, true);
                        }
                    }*/

                    // 人员
                    var rqdElement = fulldata.rqd;
                    for(var i=0;i<rqdElement.length;i++){
                        items.push({"word":rqdElement[i].key,"id":rqdElement[i].value})
                        // addItems([{word:rqdElement[i].key}])
                    }


                    /*$("#role").val(fulldata.ext[i].role);
                    $("#dept").val(fulldata.ext[i].dept);
                    $("#uid").val(fulldata.ext[i].uid);
                    $("#quarters").val(fulldata.ext[i].quarters);*/

                }else if(_startEvent[i].taskId == nodeId && fulldata){
                    dataId = fulldata.startEvent[i].dataId.split(",");
                    roleArr = fulldata.startEvent[i].role.split(",");
                    deptArr = fulldata.startEvent[i].dept.split(",");
                    quarterArr = fulldata.startEvent[i].quarters.split(",");

                    // 表单赋值
                    for(var j=0;j<dataId.length;j++){

                        $("input:checkbox[name='list']").each(function(){
                            if($(this).val()==dataId[j]){
                                $(this).attr("checked","checked");
                            }
                        })
                    }

                    // 部门赋值
                    $.fn.zTree.init($("#treeDemo1"), setting, data);

                    // 岗位赋值
                    $.fn.zTree.init($("#treeDemo"), setting, data);

                    // 人员
                    var rqdElement = fulldata.rqd;
                    for(var i=0;i<rqdElement.length;i++){
                        items.push({"word":rqdElement[i].key,"id":rqdElement[i].value})
                        // addItems([{word:rqdElement[i].key}])
                    }
                }
            }

        }


        /*$("#taskType").on("change",function(){
            var type = $("option:selected",this).val();
            console.log(type)
            if("post" == type){
                $(".cRole").addClass("hide");
                $(".cPost").removeClass("hide");
            }else if("role" == type){
                $(".cRole").removeClass("hide");
                $(".cPost").addClass("hide");
            }
        });*/

        var uid = getParam("id"); // 用户ID
        var roleList = []; // 角色列表

        $().ready(function(){
            var form = $("form[name='binding-form']");
            form.validate({
                rules: {
                    phone: { required: true, mobile:true }
                },
                submitHandler: function(){
                    var formData = $.unserialize(form.serialize());
                    var zTreeObj = $.fn.zTree.getZTreeObj("treeDemo")
                    var checkedNodes = zTreeObj.getCheckedNodes();
                    var ids = $.grep(checkedNodes, function (v) {
                        return v.type == 'QUARTERS'
                    });
                    ids = $.map(ids, function (v) {
                        return v.id;
                    });

                    var userIds = $.map($(".btn-remove[data-id]").toArray(), function (v) {
                        var id = $(v).attr("data-id")
                        return id;
                    });
                    // if(userIds.length == 0){
                    //     return
                    // }
                    var uid=[];
                    for(var i=0;i<userIds.length;i++){
                        var arr = userIds[i].split(",");
                        fulldata.rqd.push({"key":arr[1],"value":arr[0]})
                        uid.push(arr[0]);
                    }


                    var depts = "";
                    var deptZTreeObj = $.fn.zTree.getZTreeObj("treeDemo1")
                    var deptCheckedNodes = deptZTreeObj.getCheckedNodes();
                    for (var i = 0; i < deptCheckedNodes.length; i++) {
                        var node = deptCheckedNodes[i];
                        var halfCheck = node.getCheckStatus();

                        if (!halfCheck.half) {//当前结点全选
                            if (node.id == "222") {
                                depts = node.id;
                                break;
                            } else {
                                var pnode = node.getParentNode();
                                if (pnode) {
                                    var halfCheck = pnode.getCheckStatus();
                                    if (null != halfCheck) {
                                        if (!halfCheck.half) {//父节点全选则直接跳过子节点赋值
                                            continue;
                                        } else {
                                            depts += node.id + ",";
                                        }
                                    } else {
                                        depts += node.id + ",";
                                    }
                                }
                            }
                        }else{
                            continue;
                        }
                    }
                    if (depts.lastIndexOf(",") > 0) {
                        depts = depts.substring(0, depts.lastIndexOf(","));
                    }
                    console.log("==========",depts)

                    dataName = $("input:checkbox[name='list']:checked").map(function(index,elem) {
                        return $(elem).val();
                    }).get().join(',');
                    dataTitle = $("input:checkbox[name='list']:checked").map(function(index,elem) {
                        return $(elem).next().text();
                    }).get().join(',');
                    dataType = $("input:checkbox[name='list']:checked").map(function(index,elem) {
                        return $(elem).next().next().text();
                    }).get().join(',');
                    // alert($(".formInfo").next().text());

                    // var roleIds = getLayuiTabelCheckIds();
                    // ids = ids.concat(rids);
                    var roleIds =[];
                    $('table input[name="btSelectItem"]:checked').each(function(){
                        roleIds.push($(this).val());//将选中的值添加到数组chk_value中
                    });

                    formData.extMap = {
                        oids: ids
                    };
                    // formData['qids'] = [];
                    // nodes.forEach(function(item){
                    //     formData['qids'].push(item.partid)
                    // });
                    // formData['rids'] = checkedRoleIds;
                    // formData.tails = {
                    //     oids: formData.qids.concat(formData.rids)
                    // }

                    /*postFetch(remoteOrigin + "/bpm/BpmXmlController/saveTask",formData, function () {
                        closeCurrentIframe();
                    });*/


                    /*if(nodeId == -1){
                        //alert("正在请求数据，请稍后")
                        alert("该页面不支持刷新操作，请重新打开")
                        return;
                    }
                    fulldata.ext[nodeId] = {
                        a:2,
                        b:3,
                        source: 'kjl;jl;j;jl'
                    };

                    closeCurrentIframe()

                    return false;*/

                    var quarters = ids.join(',');
                    var role = "";
                    // var dept = $("#dept").val();

                    var event = nodeId.split("_")
                    if(event.length>0){
                        if("StartEvent" == event[0]){
                            fulldata.startEvent.push({"taskId":taskId,"quarters":quarters,"role":roleIds.join(","),"dept":depts,"uid":uid.join(","),"formId":formId,"dataId":dataName,"dataTitle":dataTitle,"dataType":dataType})
                        }else if("Task" == event[0]){
                            fulldata.ext.push({"taskId":taskId,"quarters":quarters,"role":roleIds.join(","),"dept":depts,"uid":uid.join(","),"formId":formId,"dataId":dataName,"dataTitle":dataTitle,"dataType":dataType})
                        }else if("EndEvent" == event[0]){

                        }
                    }

                    // fulldata.ext.push({"taskId":taskId,"quarters":quarters,"role":role,"dept":depts,"uid":uid,"formId":formId,"dataId":dataName,"dataTitle":dataTitle,"dataType":dataType})

                    closeCurrentIframe();

                    /*$.ajax({
                        type:"get",
                        url: "/bpm/BpmXmlController/saveTask?taskId="+taskId+"&&quarters="+a+"&&role="+b+"&&dept="+c+"&&uid="+d+"&&formId="+formId+"&&dataId="+dataName+"&&dataTitle="+dataTitle+"&&dataType="+dataType,
                        async:false,
                        success:function(obj){
                            if(obj["data"].length>0){
                                console.log(obj)
                            }
                        }
                    });*/

                    /*$.ajax({
                        type:"get",
                        url: "/bpm/BpmXmlController/saveTask?taskId="+taskId+"&&quarters="+ids+"&&formId="+formId+"&&dataId="+dataName+"&&dataTitle="+dataTitle+"&&dataType="+dataType,
                        async:false,
                        success:function(obj){
                            if(obj["data"].length>0){
                                console.log(obj)
                            }
                        }
                    });*/

                    // postRemoteData({
                    //     dt: "json",
                    //     loading: true,
                    //     url: remoteApi.apiUser,
                    //     data: formData,
                    //     callback: function(){
                    //         if(parent.addUserCallback){
                    //             parent.addUserCallback();
                    //         }
                    //         parent.layer.close(index);
                    //     }
                    // })
                }
            })
        })
        function checkSubmitForm(){
            return false;
        }
    </script>
</body>
</html>

<script>
    (function () {


        getFetch(
            remoteOrigin + "/api/auto/org/getSDQList"
            , function (data) {
                data = $.map(data,function (v) {
                    return {id:v.id, pId: v.parentId || 0, name: v.name, type:v.type}
                });
                // console.log(data)
                $.fn.zTree.init($("#treeDemo"), setting, data);
                var treeObj = $.fn.zTree.getZTreeObj("treeDemo");

                for(var i=0;i<quarterArr.length;i++){
                    var node = treeObj.getNodeByParam("id", quarterArr[i], null)
                    if(null != node){
                        treeObj.checkNode(node, true, true);
                    }
                }
                /*$.each(user.os || [], function (i,v) {

                    console.log(user.os)
                    console.log(v.id)
                    // console.log(v.id)
                    // console.log(treeObj.getNodeByParam("id", v.id, null))
                    var node = treeObj.getNodeByParam("id", v.id, null)
                    treeObj.checkNode(node, true, true);
                })*/
            }
        );

        getFetch(
            remoteOrigin + "/api/auto/org/getDList"
            , function (data) {
                /*data = $.map(data,function (v) {
                    console.log(">>>>>",v.children)
                    return {id:v.children.id, pId: v.children.parentId || 0, name: v.children.name, type:v.children.type}
                });
                // console.log(data)
                $.fn.zTree.init($("#treeDemo1"), setting, data);
                var treeObj = $.fn.zTree.getZTreeObj("treeDemo1");*/

                $.fn.zTree.init($("#treeDemo1"), setting, data);
                var treeObj = $.fn.zTree.getZTreeObj("treeDemo1");

                for(var i=0;i<deptArr.length;i++){
                    var node = treeObj.getNodeByParam("id", deptArr[i], null)
                    if(null != node){
                        treeObj.checkNode(node, true, true);
                    }
                }

            }
        );

        laytableRender({
            url: remoteOrigin + "/api/auto/org/getList?role=1&page=1&size=1000"
            , cols: [
                [
                    {checkbox:true}
                    , {field: "name", title:"名称"}
                ]
            ]
            , page: false
            , onRender: function () {
                console.log("roleArr",roleArr)
                /*$.each(user.os||[], function (i,v) {
                    $("[name=btSelectItem][value="+v.id+"]").prop("checked",true);
                })*/
                for(var i=0;i<roleArr.length;i++){
                    $("[name=btSelectItem][value="+roleArr[i]+"]").prop("checked",true);
                }
            }
        });

        /*laytableRender({
            id: 'dataList1',
            url: remoteOrigin + "/api/auto/user/getList?ooid=" + getParam("id"),
            cols: [
                [
                    {checkbox: true, field:"hasOrg"}
                    ,{field:'trueName', title: '姓名'},
                    {field:'username', title: '用户名'},
                ]
            ]
        });*/

    })();

</script>