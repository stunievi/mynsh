<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <!--#include file="/htmlsrc/header.html" -->
    <style>
        td{
            white-space: nowrap;
        }
    </style>
</head>
<body>
<div id="content">
    <div class="batch-operation">
        <a class="btn btn-success pub" href="javascript:;" >发起新流程</a>
<!--        <div class="btn-group">-->
<!--            <button type="button" class="btn btn-warning dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">更改启用状态<span class="caret"></span></button>-->
<!--            <ul class="dropdown-menu">-->
<!--                <li><a href="javascript:;" onclick="updateBaned(enumUserState.disabled)">禁用</a></li>-->
<!--                <li><a href="javascript:;" onclick="updateBaned(enumUserState.enable)">启用</a></li>-->
<!--            </ul>-->
<!--        </div>-->
    </div>

    <div id="dataList"></div>
</div>
</body>
</html>
<script type="text/html" id="toolbar">
    <div class="layui-toolbar">
        <!--<a class="btn btn-default handleSetMenu" href="javascript:;" data-id="{{d.id}}">功能权限</a>-->
        <!--<a class="btn btn-default" href="javascript:;" data-id="{{d.id}}" tab-title="设置岗位/角色" tab-href="/htmlsrc/sysManage/userManage/user.org.html?id={{d.id}}">岗位/角色</a>-->
        <!--<a class="btn btn-default handlePutRole" href="javascript:;" data-id="{{d.id}}">角色</a>-->
        <a class="btn btn-default btn-show" href="javascript:;" data-id="{{d._id}}">查看</a>
        {{# if(d.edit){ }}
        <a class="btn btn-default btn-edit" href="javascript:;" data-id="{{d._id}}">编辑</a>
        {{#} }}

        {{# if(d.pause){ }}
        <a class="btn btn-default btn-pause" href="javascript:;" data-id="{{d._id}}">暂停</a>
        {{#} }}

        {{# if(d.resume){ }}
        <a class="btn btn-default btn-resume" href="javascript:;" data-id="{{d._id}}">恢复</a>
        {{#} }}

        {{# if(d.forceEnd){ }}
        <a class="btn btn-default btn-forceEnd" href="javascript:;" data-id="{{d._id}}">强制结束</a>
        {{#} }}

        {{# if(d.forceResume){ }}
        <a class="btn btn-default btn-forceResume" href="javascript:;" data-id="{{d._id}}">恢复</a>
        {{#} }}

        {{# if(d.urge){ }}
        <a class="btn btn-default btn-urge" href="javascript:;" data-id="{{d._id}}">催办</a>
        {{#} }}

        <!--<a class="btn btn-default handleShow" href="javascript:;" data-id="{{d.id}}" data-name="{{d.trueName}}">查看</a>-->
<!--        <button class="btn btn-danger" delete-href="{{remoteOrigin}}/api/auto/user/delete?id={{d.id}}">删除</button>-->
    </div>
</script>
<script>
    var id = getParam("id");
    var fields = decodeURI(getParam("fields"));
    fields = JSON.parse(fields);
    var cols = [];
    $.each(fields, function (i,v) {
        cols.push({
            title: v,
            field: v
        })
    });
    cols.push({
        title:"任务状态",
        field:"state"
    })
    cols.push({
        title:"创建时间",
        field:"createTime",
    })
    cols.push({
        title:"上次提交时间",
        field:"lastModifyTime",
    })
    cols.push({
        title:"操作",
        templet: "#toolbar"
    })

    console.log(cols)
    laytableRender({
        url: remoteOrigin + "/api/bpm/workflow/insList",
        currPage: getParam("page") || 1,
        where: {
            id: id
        },
        cols: [cols],
        done: function(res, curr){
            layCurrPage = curr;
        }
    });


    $(document).on("click", ".pub", function () {
        openPubPage("pub", id);
        // window.open("./ins.pub.html?type=pub&id=" + id, "dealtask", "left=100, top=100, width=800, height=600");
    });
    $(document).on("click", ".btn-show", function () {
        var id = $(this).data("id");
        openPubPage("deal", id);
        // window.open("./ins.pub.html?type=deal&id=" + id, "dealtask", "left=100, top=100, width=800, height=600");
    })
    $(document).on("click", ".btn-edit", function () {
        var id = $(this).data("id");
        openPubPage("edit", id);
        // window.open("./ins.pub.html?type=deal&id=" + id, "dealtask", "left=100, top=100, width=800, height=600");
    })

    $(document).on("click", ".btn-pause", function () {
        var id = $(this).data("id");
        loadTimeout()
        $.get("/api/bpm/workflow/pause",{id:id}, function () {
            location.reload()
        });
    });

    $(document).on("click", ".btn-resume", function () {
        var id = $(this).data("id");
        loadTimeout()
        $.get("/api/bpm/workflow/resume",{id:id}, function () {
            location.reload()
        });
    });

    $(document).on("click", ".btn-forceEnd", function () {
        var id = $(this).data("id");
        loadTimeout()
        $.get("/api/bpm/workflow/forceEnd",{id:id}, function () {
            location.reload()
        });
    });

    $(document).on("click", ".btn-forceResume", function () {
        var id = $(this).data("id");
        loadTimeout()
        $.get("/api/bpm/workflow/forceResume",{id:id}, function () {
            location.reload()
        });
    });

    $(document).on("click", ".btn-urge", function () {
        var id = $(this).data("id");
        layer.prompt({title: '填写催办内容', formType: 2}, function(text, index){
            layer.close(index);
            loadTimeout()
            $.get("/api/bpm/workflow/urge",{id:id, msg: text}, function (msg) {
                layer.closeAll()
                if(!msg.success){
                    return layer.msg(msg.errMessage)
                }
                layer.msg("已向当前节点的处理人发送催办信息");
            },"json");
        });
    });

    function openPubPage(type, id) {
        window.open("./ins.pub.html?type="+type+"&id=" + id, "dealtask", "left=100, top=100, width=800, height=600");
    }

    // $("#panel-form").html(panelFormRender({
    //     panelTitle:'筛选查询',
    //     list:[
    //         { prop: 'name', label: '账户/姓名' },
    //         { prop: 'baned', label: '是否启用', type: 'select', vals: selectData.userState}
    //     ],
    //     data: {
    //         name: userName
    //     }
    // }));
</script>