<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,Chrome=1" />
    <meta name="renderer" content="webkit" />
    <title>股权穿透图</title>
    <!--#include file="./tupu-head.html" -->
</head>
<body style="">
<link rel="stylesheet" href="./css/qccTuPu.css" type="text/css" />

<!--#include file="./mao-head.html" -->

<div class="mao-screen-area" id="screenArea" style="height: 640px;">
    <div id="main" class="mao-main" style="height: 100%; width: 100%; -webkit-tap-highlight-color: transparent; user-select: none; background-color: rgba(0, 0, 0, 0); cursor: default;">
        <div style="position: relative; overflow: hidden; width: 1356px; height: 640px;">
        </div>
    </div>
    <div class="tupu-toolbar">
        <ul>
            <li onclick="editRect(this);"><span class="sel"></span>编辑</li>
            <li onclick="maoScale(1);"><span class="big"></span>放大</li>
            <li onclick="maoScale(2);"><span class="small"></span>缩小</li>
            <li onclick="maoRefresh();"><span class="refresh"></span>刷新</li>
            <li id="changeScreen" onclick="changeScreen(this);"><span class="screen"></span>全屏</li>
            <!--zhugeTrack('图谱-保存',{'图谱类型':'股权穿透图'});-->
            <li onclick="saveImg();"><span class="save"></span>保存</li>
        </ul>
    </div>
</div>

<div id="load_data"> <img src="./images/preloader.gif"> </div>
<div id="no_data"> <div class="guquan-lnodata pnodata"> <img src="./images/nno_image.png"> <p>没有找到相关数据</p> </div> </div>

<script src="./js/echarts2.js"></script>
<script type="text/javascript">
    $("#navTab li:eq(2)").addClass("active");
    var myChart;
    var showKeyNo;
    var Text = require('zrender/shape/Text');
    var ImageShape = require('zrender/shape/Image');
    var Rectangle = require('zrender/shape/Rectangle');
    var treeId = 1;
    var _currentKeyNo;
    var canEditRect = false;

    $(document).ready(function () {
        resizeScreen();
        myChart = echarts.init(document.getElementById('main'));
        getData();
    });

    window.onresize=function(){
        resizeScreen();
    };
    var rootData;
    var gudongData;
    var touziData;

    function getData(){
        $('#load_data').show();
        var p1 = $.ajax({
            url: remoteApi.qccECICompanyMapGetStockAnalysisData,
            data:{
                fullName: companyName
            },
            dataType: 'JSON'
        });
        var p2 = $.ajax({
            // url:"./json/guquanchuantou2.json",
            url: remoteApi.qccECIRelationSearchTreeRelationMap,
            data: {
                keyNo: companyKeyNo
            },
            dataType: 'JSON'
        });
        var p3 = $.ajax({
            // url:"./json/guquanchuantou3.json",
            url: remoteApi.qccECIRelationGetCompanyEquityShareMap,
            data: {
                keyNo: companyKeyNo
            },
            dataType: 'JSON'
        });
        var p4 = $.ajax({
            // url:"./json/guquanchuantou4.json",
            url: remoteApi.qccHoldingCompanyGetHoldingCompany,
            data: {
                page: 1,
                fullName: companyName
            },
            dataType: 'JSON'
        });

        var p5 = $.ajax({
            url: remoteApi.qccECIInvestmentThroughGetInfo,
            data: {
                fullName: companyName
            },
            dataType: 'JSON'
        });

        $.when(p1, p2, p3, p4, p5).then(function (data1, data2, data3, data4, data5) {
            // data1 十层股权穿透图
            // data2 投资图谱
            // data3 股权结构图
            // data4 控股公司
            // data5 对外投资穿透

            var retData1 = data1[0].Result || data1[0].data;
            var retData2 = data2[0].Result || data2[0].data;
            var retData3 = data3[0].Result || data3[0].data;
            var retData4 = data4[0].Result || data4[0].data;
            var retData5 = data5[0].Result || data5[0].data;

            var data = {};
            if(retData1 && retData1.StockList && retData1.StockList.Children && retData1.StockList.Children.length>0){
                var gudongDetailList = [];
                var walk1 = function(gudongDetailList, dataList){
                    dataList.forEach(function (item) {
                        item.ajaxgudong = true;
                        item.ShouldCapi = item.FundedAmount;
                        item.Percent = item.FundedRate;
                        var _index = gudongDetailList.push(item);
                        var index = _index - 1;
                        if(item.Children && item.Children.length > 0){
                            gudongDetailList[index].DetailList = [];
                            walk1(gudongDetailList[index].DetailList, item.Children)
                        }
                    });
                    return gudongDetailList;
                };
                walk1(gudongDetailList, retData1.StockList.Children);
                // 股东
                data.gudong = {
                    DetailList: gudongDetailList,
                    Name: companyName
                };
            }


            if(retData3 && retData3.ActualControllerLoopPath && retData3.ActualControllerLoopPath.length>0){
                var actualCtrl = retData3.ActualControllerLoopPath;
                // 受益人
                data.syr = {
                    KeyNo: "",
                    Names: [],
                    CompanyName: companyName
                };
                // 控制人
                data.kzr = {
                    "KeyNo": companyKeyNo,
                    "CompanyName": companyKeyNo,
                    "ControllerData":
                        {
                            "KeyNo":"",
                            "Name":"",
                            "Percent":"",
                            "PercentTotal":"0%"
                        }
                };
                actualCtrl.forEach(function (item) {
                    if(item.StockType == "自然人股东"){
                        data.syr.Names.push({
                            Name: item.Name,
                            KeyNo: "",
                            PercentTotal: item.FundedRatio
                        });
                        if(parseFloat(item.FundedRatio) > parseFloat(data.kzr.ControllerData.PercentTotal)){
                            data.kzr.ControllerData.PercentTotal = parseFloat(item.FundedRatio);
                            data.kzr.ControllerData.Name = item.Name;
                            data.kzr.ControllerData.KeyNo = item.KeyNo;
                        }
                    }
                });
            }

            var kgObj = {};
            // 控股公司
            if(retData4){
                var retData4List = retData4.Names || retData4.list || [];
                if(retData4List.length > 0){
                    data.kg = {
                        KeyNo: companyKeyNo,
                        CompanyName: companyKeyNo,
                        Names: []
                    };
                    retData4List.forEach(function (item) {
                        kgObj[item.KeyNo] = {
                            "Percent": item.PercentTotal,
                            "ShouldCapi": item.RegistCapi,
                        };
                        data.kg.Names.push(item)
                    });
                }
            }

            if(retData5 && retData5["DetailList"]){
                data.touzi = {
                    Name: companyName,
                    DetailList: retData5["DetailList"]
                };
            }else if(retData2){
                var retData2DataList = [];
                if(retData2.Node){
                    retData2DataList = retData2.Node.Children || [];
                }else{
                    retData2DataList = retData2.Children || [];
                }
                var touziDetailList = [];
                var walk1 = function(touziDetailList, dataList){
                    dataList.forEach(function (item) {
                        item.ajaxtouzi = true;
                        if(kgObj[item.KeyNo]){
                            item.ShouldCapi = kgObj[item.KeyNo].ShouldCapi;
                            item.Percent = kgObj[item.KeyNo].Percent;
                        }
                        var _index = touziDetailList.push(item);
                        var index = _index - 1;
                        if(item.Children && item.Children.length > 0){
                            touziDetailList[index].DetailList = [];
                            walk1(touziDetailList[index].DetailList, item.Children)
                        }
                    });
                    return touziDetailList;
                };

                walk1(touziDetailList, retData2DataList);
                if(touziDetailList.length===2){
                    var data2 = touziDetailList[1];
                    if(data2["Name"]== "对外投资"){
                        touziDetailList = data2["Children"];
                    }else{
                        touziDetailList = touziDetailList[0]["Children"];
                    }
                }
                // 投资
                data.touzi = {
                    Name: companyName,
                    DetailList: touziDetailList
                };
            }

            if($.isEmptyObject(data) === false){
                data.status = 200;
            }
            if(data&&data.status === 200){
                $('#no_data').hide();
                rootData = data;
                gudongData = data.gudong;
                touziData = data.touzi;
                transTree(gudongData,1);
                initTree(gudongData);
                transTree(touziData,2);
                initTree(touziData);
                drawGuquan();
                if(window.iframe){
                    setTimeout(function() {
                        if(touziData || gudongData.children.length>4){
                            maoScale(2);
                        }
                        $('.guquan-liframe').hide();
                        $(window.parent.document).find('#guquanIframeTool').show();
                    }, 500);
                }
            }else{
                $('#no_data').show();
                $('#screenArea').hide();
                if(window.iframe){
                    $('.guquan-liframe').hide();
                    $('.guquan-lnodata').show();
                }
            }
            $('#load_data').hide();
        });
    }

    function changeScreen(dom){
        if(!isFullScreen()){
            $(dom).html('<span class="screened"></span>退出');
            launchFullScreen($('#screenArea')[0]);
        }else{
            $(dom).html('<span class="screen"></span>全屏');
            exitFullScreen();
        }
    }

    //切换全屏
    setFullScreenListener(function(){
        setTimeout(function() {
            myChart.resize();
            initZrender();
        }, 300);
    })//


    function maoRefresh(){
        refresh();
    }

    function refresh(){
        var ecConfig = require('echarts/config');
        myChart._messageCenter.dispatch(ecConfig.EVENT.RESTORE, null, null, myChart);
    }

    function saveImg(){
        if(isFullScreen()){
            $('#changeScreen').html('<span class="screen"></span>全屏');
            exitFullScreen();
            setTimeout(function() {
                jietu();
            }, 1000);

        }else{
            jietu();
        }
        function jietu(){
            var jietuMask=document.createElement("div");
            $(jietuMask).attr('style','position: fixed; background: #fff; z-index: 1000; top: 0px; bottom: 0px; left: 0px; right: 0px;');
            document.body.appendChild(jietuMask);

            var width = 1440;
            var height = 900;

            var minX = 0;
            var maxX = 0;
            var minY = 300;
            var maxY = 0;
            var moveDown = 0;
            var moveRight = 0;

            var shapeList = myChart.getZrender().storage.getShapeList();
            for(var i=0;i<shapeList.length;i++){
                if(shapeList[i].style&&shapeList[i].style.iconType=='rectangle'){
                    if(shapeList[i].style.x>maxX){
                        maxX = shapeList[i].style.x;
                    }
                    if(shapeList[i].style.x<minX){
                        minX = shapeList[i].style.x;
                    }
                    if(shapeList[i].style.y>maxY){
                        maxY = shapeList[i].style.y;
                    }
                    if(shapeList[i].style.y<minY){
                        minY = shapeList[i].style.y;
                    }
                }
            }

            if((maxX-minX+300)>width){
                width = maxX-minX+300;
                moveRight = -(maxX+minX-myChart.getZrender().getWidth()+146)/2;

            }
            if((maxY-minY+300)>900){
                height = maxY-minY+300;
            }

            moveDown = -(maxY+minY-myChart.getZrender().getHeight())/2-85;

            var layer = myChart.getZrender().painter._layers[1];
            var bS = layer.scale.concat();
            var bP = layer.position.concat();

            layer.scale = [1,1,0,0];
            layer.position = [0,0];

            var bW = myChart.getZrender().getWidth();
            var bH = myChart.getZrender().getHeight();

            $('#main').width(width);
            $('#main').height(height);

            var zdW = myChart.getZrender().getWidth();
            var zdH = myChart.getZrender().getHeight();

            myChart.resize();

            myChart.getZrender().painter.refresh();

            initZrender(true);

            layer.position[0] = moveRight;
            layer.position[1] = moveDown;

            var shape1 = new Rectangle({
                style: {
                    x: -1000-moveRight,
                    y: -1000-moveDown,
                    width: width+1000,
                    height: height+1000,
                    color:'#fff'
                }
            });
            shape1.zlevel=1;
            shape1.z=-2;
            shape1.ndelete = true;
            myChart.getZrender().addShape(shape1);


            // for(var i=0;i<width+100;i+=300){
            //     for(var j=0;j<height+100;j+=228){
            //         var shapeSy = new ImageShape({
            //             style: {
            //                 image:'/shuiYin.png',
            //                 x: i-moveRight,
            //                 y: j-moveDown,
            //                 width:300,
            //                 height:228
            //
            //             }
            //         });
            //         shapeSy.zlevel=1;
            //         shapeSy.z=-1;
            //         shapeSy.ndelete = true;
            //         myChart.getZrender().addShape(shapeSy);
            //     }
            // }

            var shape3 = new Text({
                style: {
                    x: width/2-165-moveRight,
                    y: height-30-moveDown,
                    text: '股权穿透图。',
                    strokeColor:'#999',
                    color : '#999' ,
                    textFont:'normal 12px 微软雅黑',
                    lineWidth :0,
                }
            });
            shape3.zlevel=1;
            shape3.z=-1;
            shape3.ndelete = true;
            myChart.getZrender().addShape(shape3);

            setTimeout(function() {
                var canvas = $('#main canvas')[1];

                var isIE11 = (!!window.ActiveXObject || "ActiveXObject" in window);
                if(isIE11){
                    downloadimg(canvas);
                }else{
                    download(canvas,'jpg');
                }

                $('#main').width('100%');
                $('#main').height(bH);
                myChart.resize();
                layer.scale = bS;
                layer.position = bP;
                myChart.getZrender().render();
                initZrender();
                $(jietuMask).css('display','none');
            }, 300);
        }
    }

    function maoScale(type){
        var centerX = myChart.getZrender().getWidth()/2;
        var centerY = myChart.getZrender().getHeight()/2;
        var layer = myChart.getZrender().painter._layers[1];
        var x = layer.scale[0]*centerX+layer.position[0];
        var y = layer.scale[1]*centerY+layer.position[1];
        var scale = layer.scale[0];
        if(type==1){
            scale+=0.3;
        }else if(type==2){
            scale-=0.3;
        }
        if(scale>=0.3&&scale<=2){
            layer.scale[0] = scale;
            layer.scale[1] = scale;
            myChart.getZrender().render();
            layer.position[0] = x-layer.scale[0]*centerX
            layer.position[1] = y-layer.scale[1]*centerY
            myChart.getZrender().render();
        }
    }

    function editRect(dom){
        if(canEditRect){
            $(dom).removeClass('active');
            canEditRect = false;
        }else{
            $(dom).addClass('active');
            canEditRect = true;
        }
        initZrender();
    }



    function transTree(data,type){
        if(!data) return;
        data.children = data.DetailList;
        data.DetailList = undefined;
        data.treeId = treeId;
        if(type==2){
            data.isTouzi = true;
        }
        var fontSize = 12;
        if(data.ShortStatus=='注销'||data.ShortStatus=='吊销'){
            data.Name = '【'+data.ShortStatus+'】'+data.Name;
        }
        if(data.Name.length>20){
            data.name = data.Name.substr(0,19)+'…';
            data.ltext = true;
        }else{
            data.name = data.Name;
        }
        if(data.Org==2&&data.Name.length>8){
            data.name = data.Name.substr(0,7)+'…';
        }
        data.name = data.name.replace(/(.{10})(?=.)/g, '$1\n');

        if(data.StockRightNum){
            data.subtext = '持股数：'+data.StockRightNum+'';
        }else if(data.ShouldCapi){
            var capiArr = data.ShouldCapi.split(',');
            if(capiArr.length>1){
                capiNum = 0;
                $.each(capiArr,function(index,num){
                    capiNum+=parseFloat(num);
                })
            }else{
                capiNum = parseFloat(data.ShouldCapi);
            }
            if((capiNum+'').length>10){
                capiNum = capiNum.toFixed(2);
            }
            data.subtext = '认缴金额：'+capiNum+'万';
        }
        if(data.KeyNo){
            if(data.KeyNo.substr(0,1)=='t'){
                data.tag = '台湾公司';
            }else if(data.KeyNo.substr(0,1)=='h'){
                data.tag = '香港公司';
            }
        }
        if(data.Tags){
            $.each(data.Tags,function(index,vo){
                if(vo.Type==2){
                    data.tag = '上市公司';
                    data.list = true;
                }else if(vo.Type==1){
                    data.tag = '新三板公司';
                    data.list = true;
                }else if(vo.Type==401){
                    data.tag = '港股上市';
                    data.list = true;
                }
            });
        }

        data.editable = true;
        data.symbol = 'rectangle';
        data.symbolSize= [146, 62];
        if(data.tag){
            data.symbolSize= [146, 82];
        }
        data.labelClick = true;
        data.itemStyle =  {
            normal: {
                color: "#fff",
                borderWidth: "1",
                borderColor: "#ccc",
                label: {
                    show: true,
                    position: "inside",
                    textStyle: {
                        fontFamily: "MicroSoft YaHei",
                        fontSize: fontSize,
                        color:'#333',
                        fontStyle: "normal",
                    },
                }
            },
            emphasis: {
                color: "rgba(255,255,255,0)",
                borderWidth: "1",
                borderColor: "rgba(255,255,255,0)",
            }
        };

        if(data.Org==2){
            data.symbol = 'rectangle';
            data.clickable = true;
            data.labelClick = false;
            data.symbolSize= [146, 55];
            data.itemStyle =  {
                normal: {
                    color: "#F3F9FE",
                    borderWidth: "1",
                    borderColor: "#128bed",
                    label: {
                        show: !0,
                        position: "inside",
                        textStyle: {
                            color:'#333',
                            fontFamily: "MicroSoft YaHei",
                            fontSize: 14,
                            fontStyle: "normal",
                        },
                    }
                },
                emphasis: {
                    color: "rgba(255,255,255,0)",
                    borderWidth: "1",
                    borderColor: "rgba(255,255,255,0)",
                }
            };
        }

        var children = data.children;
        if(children){
            for(var i=0;i<children.length;i++){
                transTree(children[i],type);
                children[i] = addTampArrow(children[i],fontSize);
            }
        }

        if(type==1){
            if(rootData.kzr){
                if(data.KeyNo){
                    if(data.KeyNo==rootData.kzr.ControllerData.KeyNo){
                        data.kzr = true;
                    }
                }else{
                    if(data.Name==rootData.kzr.ControllerData.Name){
                        data.kzr = true;
                    }
                }
            }
            if(rootData.syr){
                $.each(rootData.syr.Names,function(index,vo){
                    if(data.KeyNo){
                        if(data.KeyNo==vo.KeyNo){
                            data.syr = vo.PercentTotal;
                        }
                    }else{
                        if(data.Name==vo.Name){
                            data.syr = vo.PercentTotal;
                        }
                    }
                })
            }
        }else if(type==2){
            if(rootData.kg){
                $.each(rootData.kg.Names,function(index,vo){
                    if(type==2&&data.KeyNo&&data.KeyNo==vo.KeyNo){
                        data.kg = true;
                    }
                })
            }
        }
        treeId++;

    }

    function addTampArrow(cnode,fontSize){
        var tamp = cnode;
        var Ratio = (!cnode.Percent||cnode.Percent=='0%')?'':cnode.Percent;
        if(Ratio){
            Ratio = (parseFloat(cnode.Percent.substr(0,cnode.Percent.length-1)).toFixed(4))*10000/10000+'%';
            tamp.ratio = Ratio;
        }
        var labelShow = (Ratio != '0%');
        cnode = {
            name:Ratio,
            symbol: "arrowdown",
            symbolSize: [12, 12],
            tooltip: {
                show: !1
            },
            clickable: !1,
            hoverable:false,
            itemStyle: {
                normal: {
                    color: "#128bed",
                    borderWidth:0,
                    label: {
                        show: labelShow,
                        position: "right",
                        textStyle: {
                            fontFamily: "MicroSoft YaHei",
                            fontSize: fontSize,
                            fontStyle: "normal",
                        },
                    }
                },
                emphasis: {
                    color: "#128bed",
                    borderWidth:0,
                    label: {
                        show: labelShow,
                        position: "right",
                        textStyle: {
                            fontFamily: "MicroSoft YaHei",
                            fontSize: fontSize,
                            fontStyle: "normal",
                        },
                    }
                }
            },
            lineStyle: {
                width: 1,
                color: "#333"
            },
            children:[tamp]
        }
        return cnode;
    }

    function initTree(data){
        if(!data) return;
        data.name = data.Name;
        data.editable = false;
        data.labelClick = false;
        data.clickable = false;
        data.symbolSize = [data.name.length*16+80, 52];
        data.symbol = 'rectangle';
        data.itemStyle =  {
            normal: {
                color: "#fff",
                borderWidth: "1",
                borderColor: "#128bed",
                label: {
                    show: !0,
                    position: "inside",
                    textStyle: {
                        color:'#000',
                        fontFamily: "MicroSoft YaHei",
                        fontSize: 16,
                        fontStyle: "normal",
                    },
                }
            },
            emphasis: {
                color: "rgba(255,255,255,0)",
                borderWidth: "1",
                borderColor: "#128bed00",
            }
        };
        getNode(gudongData);
        getNode(touziData);
        function getNode(data){
            if(!data) return;
            if(data.children){
                for(var i=0;i<data.children.length;i++){
                    getNode(data.children[i]);
                }
            }
            if(data.children&&data.children.length>0&&data.KeyNo&&data.KeyNo!=getQueryString("keyNo")){
                data._children = data.children;
                data.children = null;
                data.extend = 1;
                //data.symbol = 'rectangle';
            }

        }

    }

    //股权穿透图
    function drawGuquan(){
        myChart.clear();
        option = {
            title : {
                text: '',
            },
            series : [

            ]
        };
        var roam = true;
        if(window.iframe){
            roam = 'move';
        }
        if(gudongData){
            option.series.push({
                type: "tree",
                orient: "vertical",
                nodePadding: 25,
                layerPadding: 40,
                symbol:  "circle",
                roam: roam,
                rootLocation: {
                    "x": "50%",
                    "y": "50%"
                },
                direction:"inverse",
                data: [gudongData]
            });
        }
        if(touziData){
            option.series.push({
                type: "tree",
                orient: "vertical",
                nodePadding: 25,
                layerPadding: 40,
                symbol:  "circle",
                roam: roam,
                rootLocation: {
                    "x": "50%",
                    "y": "50%"
                },
                //direction:"inverse",
                data: [touziData]
            })
        }
        if(gudongData && !touziData){
            option.series[0].rootLocation.y = '65%';
        }
        myChart.setOption(option);
        initZrender();
        animatieChart(myChart);

        var isDrag;
        var dragStartPos;
        myChart.getZrender().on("mousedown", function (param){
            isDrag = true;
            dragStartPos = [param.event.x,param.event.y];

        });
        myChart.getZrender().on("mouseup", function (param){
            if(dragStartPos[0]==param.event.x&&dragStartPos[1]==param.event.y){
                isDrag = false;
            }
            dragStartPos = [];
        });

        myChart.on('click', function(e){
            if(isDrag) return;
            if((e.data.Org==0||e.data.Org==4||e.data.Org==7)&&e.data.KeyNo&&e.data.KeyNo!=showKeyNo){
                if(e.data.KeyNo[0]=='p'){
                    if(window.iframe){
                        window.open('/pl_'+e.data.KeyNo+'.html');
                    }else{
                        showKeyNo = e.data.KeyNo;
                        showDetail2(showKeyNo,'company_muhou4','person');
                    }
                }else{
                    if(window.iframe){
                        window.open('/firm_'+e.data.KeyNo+'.html');
                    }else{
                        showKeyNo = e.data.KeyNo;
                        showDetail(showKeyNo,'company_guquan');
                    }
                }
            }
            if(e.data.Org==2){
                if(e.data.KeyNo && e.data.KeyNo.length==32){
                    if(window.iframe){
                        window.open('/pl_'+e.data.KeyNo+'.html');
                    }else{
                        showKeyNo = e.data.KeyNo;
                        showDetail2(showKeyNo,'company_muhou4','person');
                    }
                }else{
                    window.open('/people?name='+encodeURI(e.data.Name)+'&keyno='+e.data.ParentKeyNo);
                }
            }
        });


        myChart.getZrender().on('click', function(e){
            if(isDrag) return;
            if(e.target&&e.target.clickcom){
                troggleTree(e.target.keyNo,e.target.treeId);
            }
            if(e.target&&e.target.editcom){
                editTree(e.target.keyNo,e.target.treeId);
            }
        });

        var hoverName = ''
        // myChart.on('hover', function(e){
        //     if(e.data.Name&&e.data.Name.length>10&&e.data.Name!=hoverName){
        //         hoverName = e.data.Name;
        //         $('#hoverName').text(e.data.Name);
        //         $('#hoverName').css('left',e.event.screenX-10);
        //         $('#hoverName').css('top',e.event.screenY-50);
        //         $('#hoverName').fadeIn();
        //     }
        // });
        // myChart.on('mouseout', function(e){
        //     hoverName = '';
        //     $('#hoverName').fadeOut();
        // });

        myChart.on('restore', function(param){
            getNode(gudongData);
            getNode(touziData);
            function getNode(data){
                if(!data) return;
                if(data.children){
                    for(var i=0;i<data.children.length;i++){
                        getNode(data.children[i]);
                    }
                }
                if(data.children&&data.children.length>0&&data.KeyNo&&data.KeyNo!=getQueryString("keyNo")){
                    data._children = data.children;
                    data.children = null;
                    data.extend = 1;
                    //data.symbol = 'circleCross';
                }

            }
            myChart.clear();
            myChart.setOption(option);
            initZrender();
            animatieChart(myChart);

        });

    }

    function initZrender(jietu){
        var shapeList = myChart.getZrender().storage.getShapeList();
        for(var i=0;i<shapeList.length;i++){
            if(shapeList[i].clickcom||shapeList[i].ndelete){
                myChart.getZrender().delShape(shapeList[i].id);
            }
            if(shapeList[i]._echartsData&&shapeList[i]._echartsData._data&&shapeList[i].style.text){
                shapeList[i].style.text = shapeList[i].style.text.replace(/^\s+|\s+$/g,'');
            }
        }
        for(var i=0;i<shapeList.length;i++){
            // if(shapeList[i]._echartsData&&shapeList[i]._echartsData._data.labelClick){
            //     var shape = new Text({
            //       style: {
            //           x: shapeList[i].rotation[1]+25,
            //           y: shapeList[i].rotation[2],
            //           text: shapeList[i]._echartsData._name,
            //           color : '#333' ,
            //           textFont:'normal 13px 微软雅黑',
            //           lineWidth :0,
            //       },
            //       highlightStyle : {
            //           lineWidth :0,
            //           strokeColor:'rgba(0,0,0,0)',
            //         }
            //     });
            //     shape.keyNo = shapeList[i]._echartsData._data.KeyNo;
            //     shape.zlevel = 1;
            //     shape.z = 4;
            //     shape.clickable = true;
            //     myChart.getZrender().addShape(shape);
            // }
            if(shapeList[i]._echartsData&&shapeList[i]._echartsData._data.subtext){
                shapeList[i].style.text = shapeList[i].style.text+'\n';
                var shapeY = shapeList[i].rotation[2]+12;
                if(shapeList[i]._echartsData._data.name.length>10){
                    shapeY = shapeList[i].rotation[2]+16;
                }
                if(shapeList[i]._echartsData._data.Org==2){
                    shapeY = shapeList[i].rotation[2]+11;
                }
                if(shapeList[i]._echartsData._data.tag){
                    if(shapeList[i]._echartsData._data.name.length>10){
                        shapeY = shapeList[i].rotation[2]+4;
                    }else{
                        shapeY = shapeList[i].rotation[2]+1;
                    }
                }
                var shape = new Text({
                    style: {
                        x: shapeList[i].rotation[1],
                        y: shapeY,
                        text: shapeList[i]._echartsData._data.subtext,
                        color : '#666' ,
                        textFont:'normal 11px 微软雅黑',
                        textAlign:'center',
                        lineWidth :0,
                    },
                    highlightStyle : {
                        lineWidth :0,
                        color : '#666' ,
                        strokeColor:'rgba(255,255,255,0)',
                    }
                });
                shape.zlevel = 1;
                shape.z = 5;
                shape.ndelete = true;
                shape.hoverable = false;
                myChart.getZrender().addShape(shape);
            }
            if(shapeList[i]._echartsData&&shapeList[i]._echartsData._data.extend&&!jietu){
                var iconImg = '';
                var isIE11 = (!!window.ActiveXObject || "ActiveXObject" in window);
                if(shapeList[i]._echartsData._data.extend==1){
                    if(isIE11){
                        iconImg = './image/tupu_cross.png';
                    }else{
                        iconImg = './image/tupu_cross.svg';
                    }
                }else if(shapeList[i]._echartsData._data.extend==2){
                    if(isIE11){
                        iconImg = './image/tupu_minus.png';
                    }else{
                        iconImg = './image/tupu_minus.svg';
                    }

                }
                var shapeY = shapeList[i].rotation[2];
                if(shapeList[i]._echartsData._data.isTouzi){
                    shapeY = shapeY + shapeList[i].style.height/2;
                }else{
                    shapeY = shapeY - shapeList[i].style.height/2-18;
                }
                var shape = new ImageShape({
                    style: {
                        image:iconImg,
                        x: shapeList[i].rotation[1]-9,
                        y: shapeY,
                        width:18,
                        height:18

                    }
                });
                shape.keyNo = shapeList[i]._echartsData._data.KeyNo;
                shape.treeId = shapeList[i]._echartsData._data.treeId;
                shape.zlevel = 1;
                shape.z = 4;
                shape.ndelete = true;
                shape.clickcom = true;
                shape.hoverable = true;
                shape.clickable = true;
                myChart.getZrender().addShape(shape);
            }
            if(shapeList[i]._echartsData&&shapeList[i]._echartsData._data.editable&&canEditRect&&!jietu){
                var iconImg = '';
                var isIE11 = (!!window.ActiveXObject || "ActiveXObject" in window);
                if(isIE11){
                    iconImg = './image/tupu_delete.png';
                }else{
                    iconImg = './image/tupu_delete.svg';
                }
                var shapeY = shapeList[i].rotation[2];
                if(shapeList[i]._echartsData._data.isTouzi){
                    shapeY = shapeY - shapeList[i].style.height/2-9;
                }else{
                    shapeY = shapeY - shapeList[i].style.height/2-18+9;
                }
                var shape = new ImageShape({
                    style: {
                        image:iconImg,
                        x: shapeList[i].rotation[1]-9+72,
                        y: shapeY,
                        width:18,
                        height:18

                    }
                });
                shape.zlevel = 1;
                shape.z = 20;
                shape.keyNo = shapeList[i]._echartsData._data.KeyNo;
                shape.treeId = shapeList[i]._echartsData._data.treeId;
                shape.ndelete = true;
                shape.editcom = true;
                shape.hoverable = true;
                shape.clickable = true;
                myChart.getZrender().addShape(shape);
            }
            if(shapeList[i]._echartsData&&shapeList[i]._echartsData._data.kzr&&shapeList[i]._echartsData._data.syr){
                var shape = new ImageShape({
                    style: {
                        image:'./image/tupu_kzrsbg.png',
                        x: shapeList[i].rotation[1]-75,
                        y: shapeList[i].rotation[2]-shapeList[i].style.height/2-38,
                        width:150,
                        height:44,
                    },
                    highlightStyle : {
                        lineWidth :0,
                        strokeColor:'#fff',
                    }
                });
                var shapeText = new Text({
                    style: {
                        x: shapeList[i].rotation[1],
                        y: shapeList[i].rotation[2]-shapeList[i].style.height/2-18,
                        textFont:'normal 11px 微软雅黑',
                        text:'实际控制人\n'+'最终受益人：'+shapeList[i]._echartsData._data.syr,
                        textAlign:'center',
                        color : '#fff',
                        lineWidth :0,
                    },
                    highlightStyle : {
                        lineWidth :0,
                        strokeColor:'rgba(255,255,255,0)',
                    }
                });
                shape.ndelete = true;
                shape.zlevel = 1;
                shape.z = 8;
                shape.hoverable = false;
                shapeText.zlevel = 1;
                shapeText.z = 10;
                shapeText.ndelete = true;
                shapeText.hoverable = false;
                myChart.getZrender().addShape(shape);
                myChart.getZrender().addShape(shapeText);
            }else if(shapeList[i]._echartsData&&shapeList[i]._echartsData._data.kzr){
                var shape = new ImageShape({
                    style: {
                        image:'./image/tupu_kzrbg.png',
                        x: shapeList[i].rotation[1]-75,
                        y: shapeList[i].rotation[2]-shapeList[i].style.height/2-24,
                        width:150,
                        height:30,
                    },
                    highlightStyle : {
                        lineWidth :0,
                        strokeColor:'rgba(255,255,255,0)',
                    }
                });
                var shapeText = new Text({
                    style: {
                        x: shapeList[i].rotation[1],
                        y: shapeList[i].rotation[2]-shapeList[i].style.height/2-12,
                        textFont:'normal 11px 微软雅黑',
                        text:'实际控制人',
                        textAlign:'center',
                        color : '#fff',
                        lineWidth :0,
                    },
                    highlightStyle : {
                        lineWidth :0,
                        color : '#F5A623' ,
                        strokeColor:'rgba(255,255,255,0)',
                    }
                });
                shape.ndelete = true;
                shape.zlevel = 1;
                shape.z = 8;
                shape.hoverable = false;
                shapeText.zlevel = 1;
                shapeText.z = 10;
                shapeText.ndelete = true;
                shapeText.hoverable = false;
                myChart.getZrender().addShape(shape);
                myChart.getZrender().addShape(shapeText);

            }else if(shapeList[i]._echartsData&&shapeList[i]._echartsData._data.syr){
                var shape = new ImageShape({
                    style: {
                        image:'./images/tupu_syrbg.png',
                        x: shapeList[i].rotation[1]-75,
                        y: shapeList[i].rotation[2]-shapeList[i].style.height/2-24,
                        width:150,
                        height:30,
                    },
                    highlightStyle : {
                        lineWidth :0,
                        strokeColor:'rgba(255,255,255,0)',
                    }
                });
                var shapeText = new Text({
                    style: {
                        x: shapeList[i].rotation[1],
                        y: shapeList[i].rotation[2]-shapeList[i].style.height/2-12,
                        textFont:'normal 11px 微软雅黑',
                        text:'最终受益人：'+shapeList[i]._echartsData._data.syr,
                        textAlign:'center',
                        color : '#fff',
                        lineWidth :0,
                    },
                    highlightStyle : {
                        lineWidth :0,
                        color : '#F5A623' ,
                        strokeColor:'rgba(255,255,255,0)',
                    }
                });
                shape.ndelete = true;
                shape.zlevel = 1;
                shape.z = 8;
                shape.hoverable = false;
                shapeText.zlevel = 1;
                shapeText.z = 10;
                shapeText.ndelete = true;
                shapeText.hoverable = false;
                myChart.getZrender().addShape(shape);
                myChart.getZrender().addShape(shapeText);

            }
            if(shapeList[i]._echartsData&&shapeList[i]._echartsData._data.kg){
                var shapeY = shapeList[i].rotation[2]-shapeList[i].style.height/2-21.5;
                if(shapeList[i]._echartsData._data.tag){
                    shapeY += 9;
                }
                var shapeX = shapeList[i].rotation[1] + 28
                if(shapeList[i]._echartsData._data.ratio){
                    shapeX += shapeList[i]._echartsData._data.ratio.length*10
                    if(shapeList[i]._echartsData._data.ratio.indexOf('.') != -1){
                        shapeX -= 10;
                    }
                }
                var shapeText = new Text({
                    style: {
                        x: shapeX,
                        y: shapeY,
                        textFont:'normal 11px 微软雅黑',
                        text:'(控股)',
                        textAlign:'center',
                        color : '#FD485E',
                        lineWidth :0,
                    },
                    highlightStyle : {
                        lineWidth :0,
                        color : '#FD485E' ,
                        strokeColor:'rgba(255,255,255,0)',
                    }
                });
                shapeText.zlevel = 1;
                shapeText.z = 10;
                shapeText.ndelete = true;
                shapeText.hoverable = false;
                myChart.getZrender().addShape(shapeText);
            }
            if(shapeList[i]._echartsData&&shapeList[i]._echartsData._data.tag){
                shapeList[i].style.text = shapeList[i].style.text+'\n\n';
                var shapeColor = '#FFECCE';
                var shapeTextColor = '#F5A623';
                if(shapeList[i]._echartsData._data.list){
                    shapeColor = '#DDF0FF';
                    shapeTextColor = '#128bed';
                }

                var shape = new Rectangle({
                    style: {
                        x: shapeList[i].rotation[1]-72.5,
                        y: shapeList[i].rotation[2]+shapeList[i].style.height/2-22.5,
                        width:145,
                        height:22,
                        color:shapeColor,
                    },
                    highlightStyle : {
                        lineWidth :0,
                        color:'rgba(255,255,255,0)',
                        strokeColor:'#fff',
                    }
                });
                var shapeText = new Text({
                    style: {
                        x: shapeList[i].rotation[1]-2,
                        y: shapeList[i].rotation[2]+shapeList[i].style.height/2-12,
                        textFont:'normal 12px 微软雅黑',
                        text: shapeList[i]._echartsData._data.tag,
                        textAlign:'center',
                        color : shapeTextColor,
                        fontSize:14,
                        lineWidth :0,
                    },
                    highlightStyle : {
                        lineWidth :0,
                        color : shapeTextColor ,
                        strokeColor:'rgba(255,255,255,0)',
                    }
                });
                shape.zlevel = 1;
                shape.z = 4;
                shape.ndelete = true;
                shape.hoverable = false;
                shapeText.zlevel = 1;
                shapeText.z = 5;
                shapeText.ndelete = true;
                shapeText.hoverable = false;
                myChart.getZrender().addShape(shape);
                myChart.getZrender().addShape(shapeText);
            }
        }

        for(var i=0;i<myChart.getZrender().getWidth()+100;i+=300){
            for(var j=0;j<myChart.getZrender().getHeight()+100;j+=228){
                var shapeSy = new ImageShape({
                    style: {
                        x: i,
                        y: j,
                        width:300,
                        height:228
                    }
                });
                shapeSy.hoverable = false;
                shapeSy.ndelete = true;
                myChart.getZrender().addShape(shapeSy);
            }
        }
    }


    function editTree(KeyNo,tid){
        getNode(gudongData);
        getNode(touziData);
        var dnode;
        var dIndex;
        function getNode(data){
            if(!data) return;
            if(data.children){
                for(var i=0;i<data.children.length;i++){
                    var cnode = data.children[i].children[0];
                    if(cnode.treeId==tid){
                        dIndex = i;
                        dnode = data;
                        return;
                    }
                    getNode(cnode);
                }
            }
        }
        dnode.children.splice(dIndex, 1);
        if(dnode.children.length==0){
            dnode.children = [];
            dnode.extend = undefined;
        }
        myChart.clear();
        myChart.setOption(option);
        initZrender();
    }

    function troggleTree(KeyNo,tid){
        // if(KeyNo==getQueryString("keyNo")){
        //     return;
        // }
        getNode(gudongData);
        getNode(touziData);
        function getNode(data){
            if(!data) return;
            if(data.KeyNo&&data.KeyNo==KeyNo && data.treeId==tid){
                if(data.children){
                    data._children = data.children;
                    data.children = null;
                    data.extend = 1;
                    //data.symbol = 'circleCross';
                }else if(data._children){
                    data.children = data._children;
                    data._children = null;
                    data.extend = 2;
                    ajaxtouzidata(data,KeyNo);
                    ajaxgudongdata(data, KeyNo);
                    //data.symbol = 'circleMinus';
                }
                return;
            }
            if(data.children){
                for(var i=0;i<data.children.length;i++){
                    getNode(data.children[i]);
                }
            }
        }
        myChart.clear();
        myChart.setOption(option);
        initZrender();
    }



    function ajaxtouzidata(node,KeyNo) {
        if(!node.isTouzi || node.ajaxtouzi){
            return;
        }
        $.ajax({
            url:INDEX_URL+'cms_guquanmapinvestment',
            data:{
                keyNo:KeyNo
            },
            dataType:'JSON',
            success:function(data){
                if(data.touzi&&data.touzi.DetailList.length>0){
                    addTreeChild(node,data);
                }
            },
        })
    }

    function addTreeChild(node,data){
        if(!node.children){
            return;
        }
        $.each(node.children,function(index,vo){
            var cnode = vo.children[0];
            $.each(data.touzi.DetailList,function(i,ndata){
                if(ndata.KeyNo==cnode.KeyNo){
                    if(ndata.DetailList.length>0){
                        cnode.DetailList = ndata.DetailList;
                        transTree(cnode,2);
                        cnode._children = cnode.children;
                        cnode.children = null;
                        cnode.extend = 1;
                    }

                }
            })
        })
        node.ajaxtouzi = true;
        myChart.clear();
        myChart.setOption(option);
        initZrender();
    }

    //动态加载股东节点
    function ajaxgudongdata(node, KeyNo) {
        if (node.isTouzi || node.ajaxgudong) {
            return;
        }
        if (KeyNo == null) {
            return;
        }
        $.ajax({
            url:INDEX_URL+'cms_guquanmapownership',
            data: {
                keyNo: KeyNo,
                level: 2,
            },
            dataType: 'JSON',
            success: function (data) {
                if(data.gudong&&data.gudong.DetailList.length>0){
                    addGudongTreeChild(node, data);
                }
            }
        })
    }
    function addGudongTreeChild(node, data) {
        $.each(node.children, function (index, vo) {
            var cnode = vo.children[0];
            $.each(data.gudong.DetailList, function (i, ndata) {
                if (ndata.KeyNo == cnode.KeyNo && ndata.Name == cnode.Name) {
                    if (ndata.DetailList.length > 0) {
                        cnode.DetailList = ndata.DetailList;
                        transTree(cnode, 1);
                        cnode._children = cnode.children;
                        cnode.children = null;
                        cnode.extend = 1;
                    }

                }
            })
        })
        node.ajaxgudong = true;
        myChart.clear();
        myChart.setOption(option);
        initZrender(false,'');
    }




    function resizeScreen(){
        if(document.body.clientHeight>700){
            $('#screenArea').height(document.body.clientHeight-66);
        }else if(window.iframe){
            $('#screenArea').width(886);
            $('#screenArea').height(418);
            $('#main').width(886);
            $('#main').height(418);
        }else{
            $('#screenArea').height(640);
        }
    }

    function popclose(dom){
        $(dom).parent().parent().fadeOut();
        if(showKeyNo){
            showKeyNo = '';
        }
    }

    function personImgErr() {
        var name = $(".ea_name").text();
        $('#face_oss').hide();
        $('.ea_defaultImg').show();
        $('.ea_defaultImg').text(name[0]);
    }

    if(window.iframe){
        $('.navi-header').hide();
        $('.mao-head').hide();
        $('.tupu-toolbar').hide();
        $('.water-mark').css('bottom','10px');
        timeoutRoam();
    }
    function timeoutRoam(){
        var roamTimer;
        var roamed =false;
        $('#main').on('mouseenter',function(e){
            if(!roamed){
                roamTimer = setTimeout(function() {
                    $.each(option.series,function(i,v){
                        v.roam = true;
                    })
                    myChart.clear();
                    myChart.setOption(option);
                    initZrender();
                    roamed = true;
                }, 800);
            }
        })
        $('#main').on('mouseout',function(e){
            if(roamTimer){
                clearTimeout(roamTimer);
                roamTimer = null;
            }
            if(roamed){
                $.each(option.series,function(i,v){
                    v.roam = 'move';
                })
                myChart.clear();
                myChart.setOption(option);
                initZrender();
                roamed = false;
            }
        })
    }

    function downloadimg(canvas) {
        var qual = 1;
        if(canvas.width>3000){
            qual = 0.5;
        }else if(canvas.width>5000){
            qual = 0.4;
        }
        //设置保存图片的类型
        var imgdata = canvas.toDataURL('image/jpeg',qual);
        var filename = '股权穿透图_'+new Date().toLocaleDateString() + '.jpeg';
        post(INDEX_URL+'cms_downloadimg?filename='+filename, {img:imgdata});
    }
    function post(URL, PARAMS) {
        var temp = document.createElement("form");
        temp.action = URL;
        temp.enctype = "multipart/form-data";
        temp.method = "post";
        temp.style.display = "none";
        for (var x in PARAMS) {
            var opt = document.createElement("textarea");
            opt.name = x;
            opt.value = PARAMS[x];
            temp.appendChild(opt);
        }
        document.body.appendChild(temp);
        temp.submit();
        return temp;
    }
</script>
<style>
    /*详情弹窗*/
    .company-detail{padding: 0px;top:75px;}
    .detail-content-wrap{padding: 10px 20px;}
    .detail-bottom{height: 350px;overflow-y: auto;padding-right: 3px;}
    .detail-title-wrap{margin-bottom:10px;}
    .detail-title{color:#000000;font-size: 16px;font-weight:600;}
    .detail-count{color:#128BED;font-size: 16px;padding-left:6px;}
    .detail-a,.detail-a:hover{color:#128BED;font-size: 14px;}
    .detail-content{border:1px solid #E4EEF6;padding: 12px;margin-bottom: 20px;}
    #NameBar{position: absolute;background: white;width:252px;height:30px;bottom:362px;/*bottom:346px;*/line-height: 30px;z-index: 2;
        font-size:16px;font-weight: 600;}
    #NameBar .detail-count{font-weight: normal;}
    #NameBar .detail-a{font-weight: normal;margin-right:10px;}

    /**/
    #ScrollContent .detail-title-wrap a.pull-right{margin-right: 10px;}

    .marginNone{margin-bottom: 0px !important;}

</style>
<script type="text/template" id="PerDeailTpl">
    <div id="ScrollContent" class="m-t mao-content m-b-lg detail-bottom">
        <div class="detail-title-wrap" style="margin-top: 0px;">
            <span class="detail-title">简介</span>
        </div>
        <div class="detail-content">
            <div class="e_contentMore">
                <div class="ea_content"><span id="des">暂无</span></div>
                <a class="ea_bt">...展开</a>
            </div>
        </div>
        <div id="glgs" class="detail-title-wrap">
            <span class="detail-title">关联公司</span><span class="relativeInfoCount detail-count">0</span><a target="_blank" class="detail-a pull-right allRrelative">查看全部></a>
        </div>
        <table class="ntable">
            <thead><tr><th  class="tb" style="text-align: left;">名称</th><th  class="tb" style="width: 96px;">法定代表人</th></tr></thead>
            <tbody id="relativeInfoData">

            </tbody>
        </table>

        <div id="BossInfo" style="display: none;">
            <div class="detail-title-wrap">
                <span class="detail-title">基本信息</span>
            </div>
            <table class="ntable">
                <tbody>
                <tr><td class="tb" style="width: 85px;">毕业院校</td><td id="biye">-</td></tr>
                <tr><td class="tb">所学专业</td><td id="zhuanye">-</td></tr>
                <tr><td class="tb">最高学历</td><td id="xueli">-</td></tr>
                <tr><td class="tb">爱好</td><td id="hobby">-</td></tr>
                <tr><td class="tb">工作单位</td><td id="companyname">-</td></tr>
                <tr><td class="tb">职务</td><td id="job">-</td></tr>
                </tbody>
            </table>
            <div id="edu-wrap">
                <div class="detail-title-wrap">
                    <span class="detail-title">教育经历</span>
                </div>
                <div id="edu"></div>
            </div>
            <div id="everjob-wrap">
                <div class="detail-title-wrap">
                    <span class="detail-title">工作经历</span>
                </div>
                <div id="everjob">

                </div>
            </div>
            <div id="milestone-wrap">
                <div class="detail-title-wrap">
                    <span class="detail-title">重要事件</span>
                </div>
                <table class="ntable">
                    <tbody id="milestone">
                    <tr><td>暂无</td></tr>
                    </tbody>
                </table>
            </div>
            <div id="sayings-wrap">
                <div class="detail-title-wrap">
                    <span class="detail-title">相关新闻</span>
                </div>
                <table class="ntable">
                    <tbody id="sayings">
                    <tr><td>暂无</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</script>
<script>
    /*详情滚动时显示标题*/
    function scrollTitleInit() {
        // 滚动显示标题
        var showIndex = 0;
        var pos = [];
        var showWraps = [];
        var wraps = document.getElementsByClassName("detail-title-wrap");
        for(var i = 0; i < wraps.length; i++){
            var w = wraps[i];
            var obj = {name:'',y:0}
            obj.name = $(w).find(".detail-title").text();
            obj.y = w.offsetTop;
            if(obj.y || i == 0){
                pos.push(obj);
                showWraps.push(w);
            }
        }
        $("#NameBar").html($(showWraps[0]).html());
        $('#ScrollContent').scroll(function () {
            var top = $(this).scrollTop();
            top += 250;

            showIndex = 0;
            for(var i = 0; i < pos.length; i++){
                if((i+1) < pos.length && top < pos[i+1].y){
                    showIndex = i;
                    break;
                }
                if((i+1) == pos.length){
                    showIndex = i;
                }
            }

            $("#NameBar").html($(showWraps[showIndex]).html());
            $("#NameBar").show();
        });
    }

    /**/
    function showDetail2(keyNo,tupuUrl,type){
        $(".company-detail").hide();

        if(type && type == 'person'){
            var url = INDEX_URL+"boss_getDetail";
            $.ajax({
                url: url,
                type: 'GET',
                data: {"keyNo": keyNo},
                dataType: 'JSON',
                success: function (data) {
                    if(!data.name) return;
                    $("#ScrollContent").remove();
                    // $("#ShowPerTupu").after($("#PerDeailTpl").html());

                    $("#NameBar").after($("#PerDeailTpl").html());

                    /*人物搜索里的查看图谱*/
                    if(_currentKeyNo == keyNo || !data.boss_id){
                        $("#ShowPerTupu").attr('canshow','0');
                        $("#ShowPerTupu").hide();
                    } else {
                        $("#ShowPerTupu").attr('keyno',keyNo);
                        $("#ShowPerTupu").attr('canshow','1');
                        $("#ShowPerTupu").show();
                    }
                    /*muhou3 muhou4里的查看图谱*/
                    if(_currentKeyNo == keyNo){
                        $("#ShowPerTupuA").parent().hide();
                    } else {
                        $("#ShowPerTupuA").parent().show();
                        $("#ShowPerTupuA").attr("href","/company_muhou4?keyNo="+keyNo+"&name="+encodeURIComponent(data.name));
                    }

                    $("#BossInfo").hide();

                    $('.allRrelative').attr('href','/pl_'+keyNo);

                    $('.ea_name').text(data.name ? data.name : '-');
                    $('.ea_name').attr('href','/pl_'+keyNo);


                    $('.ea_defaultImg').text();
                    $('.ea_defaultImg').hide();
                    $('#face_oss').show();
                    if(data.boss_id){
                        $('#face_oss').attr('src',data.face_oss);
                    } else {
                        $('#face_oss').attr('src','' );
                    }

                    $('#PerCom').text(data.companyname ? data.companyname : '-');
                    $('#PerJob').text(data.job ? data.job : '-');
                    if(data.companykey){
                        $('#PerCom').attr('href','/firm_'+data.companykey);
                    } else {
                        $('#PerCom').attr('href','');
                    }
                    $("#des").parent().parent().removeAttr('style');

                    $("#des").text(data.des ? data.des : '暂无');
                    /*简介没有时隐藏*/
                    if(!data.des){
                        var desWrap = $("#des").parent().parent().parent();
                        desWrap.siblings('.detail-title-wrap').eq(0).remove();
                        desWrap.remove();
                    }


                    $(".relativeInfoCount").text(data.relativeInfoCount ? data.relativeInfoCount : '0');

                    $("#relativeInfoData").html('');
                    if(data.relativeInfoData && data.relativeInfoData.length){
                        var html = '';
                        data.relativeInfoData.forEach(function (obj,index) {
                            obj.Name = obj.Name ? obj.Name : '-';
                            obj.OperName = obj.OperName ? obj.OperName : '-';
                            if(index < 10){
                                html += '<tr><td>' +
                                    '<a class="c_a" target="_blank" href="/firm_'+obj.KeyNo+'"><span>'+ obj.Name +'</span></a></td>'  +
                                    '<td style="text-align: center;">'+ obj.OperName +'</td></tr>'
                            }
                        })
                        $("#relativeInfoData").html(html);
                    }

                    if(data.boss_id){ // 热门人物
                        $("#BossInfo").show();
                        $('#biye').text(data.biye ? data.biye : '-');
                        $('#zhuanye').text(data.zhuanye ? data.zhuanye : '-');
                        $('#xueli').text(data.xueli ? data.xueli : '-');
                        $('#hobby').text(data.hobby ? data.hobby : '-');
                        $('#companyname').text(data.companyname ? data.companyname : '-');
                        $('#job').text(data.job ? data.job : '-');
                        /*教育经历*/
                        $('#edu').html('');
                        var edus = '';
                        if(data.edu){
                            edus = JSON.parse(data.edu);
                        }
                        if(data.edu && edus && edus.length){
                            var html = '';
                            edus.forEach(function (obj) {
                                if(!obj.TimeQuantum){obj.TimeQuantum = '-'}
                                if(!obj.Diplomas){obj.Diplomas = '-'}
                                if(!obj.University){obj.University = '-'}
                                if(!obj.Major){obj.Major = '-'}
                                html += '<table class="ntable"><tbody>' +
                                    '<tr><td class="tb" style="width: 85px;">教育时间</td><td >'+ obj.TimeQuantum +'</td></tr>'+
                                    '<tr><td class="tb">学历</td><td>'+ obj.Diplomas +'</td></tr>'+
                                    '<tr><td class="tb">毕业院校</td><td>'+ obj.University +'</td></tr>'+
                                    '<tr><td class="tb">所学专业</td><td>'+ obj.Major +'</td></tr>'+
                                    '</tbody></table>';
                            })
                            $('#edu').html(html);
                            $('#edu-wrap').show();
                        } else {
                            $('#edu-wrap').hide();
                        }
                        /*工作经历*/
                        $('#everjob').html('');
                        var jobs = '';
                        if(data.everjob){
                            jobs = JSON.parse(data.everjob);
                        }
                        if(data.everjob && jobs && jobs.length){
                            var html = '';
                            jobs.forEach(function (obj) {
                                if(!obj.TimeQuantum){obj.TimeQuantum = '-'}
                                if(!obj.Job){obj.Job = '-'}
                                if(!obj.CompanyName){obj.CompanyName = '-'}
                                if(!obj.Abstract){obj.Abstract = '-'}
                                html += '<table class="ntable"><tbody>' +
                                    '<tr><td class="tb" style="width: 85px;">工作时间</td><td >'+ obj.TimeQuantum +'</td></tr>'+
                                    '<tr><td class="tb">职位</td><td>'+ obj.Job +'</td></tr>'+
                                    '<tr><td class="tb">工作单位</td><td>'+ obj.CompanyName +'</td></tr>'+
                                    '<tr><td class="tb">描述</td><td>'+
                                    '<div class="e_contentMore">'+
                                    '<div class="ea_content">'+ obj.Abstract +'</div>'+
                                    '<a class="ea_bt">...展开</a>'+
                                    '</div>'+
                                    '</td></tr>'+
                                    '</tbody></table>';
                            })
                            $('#everjob').html(html);
                            $('#everjob-wrap').show();
                        } else {
                            $('#everjob-wrap').hide();
                        }
                        /*重要事件*/
                        $('#milestone').html('');
                        var milestones = '';
                        if(data.milestone){
                            milestones = JSON.parse(data.milestone);
                        }
                        if(data.milestone && milestones && milestones.length){
                            var html = '';
                            milestones.forEach(function (obj) {
                                if(!obj.Milestone){obj.Milestone = '-'}
                                html += '<tr><td><div class="e_contentMore">'+
                                    '<div class="ea_content">'+ obj.Milestone +'</div>'+
                                    '<a class="ea_bt">...展开</a>'+
                                    '</div></td></tr>';
                            })
                            $('#milestone').html(html);
                            $('#milestone-wrap').show();
                        }else {
                            $('#milestone-wrap').hide();
                        }
                        /*相关新闻*/
                        $('#sayings').html('');
                        var sayings = '';
                        if(data.sayings){
                            sayings = JSON.parse(data.sayings);
                        }
                        if(data.sayings && sayings && sayings.length){
                            var html = '';
                            sayings.forEach(function (obj) {
                                if(!obj.TimeQuantum){obj.TimeQuantum = '-'}
                                if(!obj.Job){obj.Job = '-'}
                                if(!obj.CompanyName){obj.CompanyName = '-'}
                                if(!obj.Abstract){obj.Abstract = '-'}
                                obj.Link = obj.Link.replace('http://','');
                                obj.Link = obj.Link.replace('https://','');
                                html += '<tr><td><a target="_blank" href="http://'+ obj.Link +'">'+ obj.Title +'</a></td></tr>';
                            })
                            $('#sayings').html(html);
                            $('#sayings-wrap').show();
                        }else {
                            $('#sayings-wrap').hide();
                        }
                    }

                    $("#person-detail").fadeIn();

                    /*e_contentMore元素初始化*/
                    $(".e_contentMore").each(function () {
                        var wrap = $(this);
                        var content = wrap.find(".ea_content");
                        var bt = wrap.find(".ea_bt");

                        var wrapHeight = wrap.height();
                        var contentHeight = content.height();
                        if(contentHeight > wrapHeight){
                            bt.show();
                        } else {
                            bt.hide();
                        }
                        bt.click(function () {
                            if(bt.text() == "收起"){
                                wrap.css({maxHeight:wrapHeight});
                                bt.text("...展开");
                            } else {
                                wrap.css({maxHeight:(contentHeight + 20),height:(contentHeight + 20)});
                                bt.text("收起");
                            }

                            scrollTitleInit();
                        });
                    })

                    /*样式处理,bug #2191-1*/
                    if($("#BossInfo").is(':hidden')){
                        $("#glgs").siblings('.ntable').addClass('marginNone');
                    } else {
                        $("#glgs").siblings('.ntable').removeClass('marginNone');
                    }

                    /*$('#ScrollContent').slimScroll({
                        wheelStep: 1
                    });*/

                    scrollTitleInit();

                },
                error:function(data){
                    console.log(data);
                }
            });
        } else {
            var url = INDEX_URL+"more_findRelationsDetail";
            $.ajax({
                url: url,
                type: 'GET',
                data: {"keyNo": keyNo},
                dataType: 'JSON',
                success: function (data) {
                    if(data.Status!=200){
                        return;
                    }
                    var companyDetail = $('#company-detail');
                    companyDetail.find('.mao-img').attr("src",data.Result.ImageUrl);
                    companyDetail.find('.mao-company-name').text(data.Result.Name);
                    companyDetail.find('.mao-company-status').text(data.Result.ShortStatus||'-');
                    if(data.Result.Oper&&data.Result.Oper.Name){
                        if(data.Result.Oper.KeyNo){
                            if(data.Result.Oper.KeyNo[0]=='p'){
                                companyDetail.find('.mao-oper').html('<a target="_blank" href="/pl_'+data.Result.Oper.KeyNo+'.html">'+data.Result.Oper.Name+'</a>');
                            }else{
                                companyDetail.find('.mao-oper').html('<a target="_blank" href="/firm_'+data.Result.Oper.KeyNo+'.shtml">'+data.Result.Oper.Name+'</a>');
                            }
                        }else{
                            companyDetail.find('.mao-oper').html('<a target="_blank" href="/people?name='+encodeURI(data.Result.Oper.Name)+'&keyno='+keyNo+'">'+data.Result.Oper.Name+'</a>');
                        }
                        if(data.Result.Oper.OperType==1){
                            companyDetail.find('.mao-oper').prev().text('法定代表人：');
                        }else if(data.Result.Oper.OperType==2){
                            companyDetail.find('.mao-oper').prev().text('执行事务合伙人：');
                        }else if(data.Result.Oper.OperType==3){
                            companyDetail.find('.mao-oper').prev().text('负责人：');
                        }else if(data.Result.Oper.OperType==4){
                            companyDetail.find('.mao-oper').prev().text('经营者：');
                        }else if(data.Result.Oper.OperType==5){
                            companyDetail.find('.mao-oper').prev().text('投资人：');
                        }else if(data.Result.Oper.OperType==6){
                            companyDetail.find('.mao-oper').prev().text('董事长：');
                        }else if(data.Result.Oper.OperType==7){
                            companyDetail.find('.mao-oper').prev().text('理事长：');
                        }
                    }else{
                        companyDetail.find('.mao-oper').text('-');
                    }

                    companyDetail.find('.mao-ziben').text(data.Result.RegistCapi || '-');
                    companyDetail.find('.mao-date').text((data.Result.StartDate || ''));
                    companyDetail.find('.mao-company-name').attr("href","firm_"+keyNo+".shtml");
                    if(!tupuUrl){
                        tupuUrl = 'company_relation';
                    }
                    companyDetail.find('.mao-tupu-link').attr("href",tupuUrl+"?keyNo="+keyNo+"&name="+encodeURIComponent(data.Result.Name));
                    //companyDetail.find('.mao-tupu-link').attr("onclick","zhugeTrack(\'图谱页面-侧边栏企业信息-查看图谱\')");
                    companyDetail.find('.close').click(function(){
                        companyDetail.fadeOut();
                    });

                    if(_currentKeyNo == keyNo){
                        $(".mao-tupu-link").parent().hide();
                    } else {
                        $(".mao-tupu-link").parent().show();
                    }

                    var noData = '<div class="mao-noresult"> <p ><img src="./images/nodata.png"></p>暂无信息</div>';

                    //股东
                    if(data.Result.Partners && data.Result.Partners.length>0){
                        var html = '<table class="ntable">';
                        html += "<thead><tr><th style='text-align: left'>名称</th><th>类型</th></tr></thead>";
                        for(var i=0; i<data.Result.Partners.length; i++){
                            html += "<tr>";
                            if(data.Result.Partners[i].KeyNo){
                                if(data.Result.Partners[i].KeyNo[0]=='p'){
                                    html += '<td><a onclick="" target="_blank" href="/pl_'+data.Result.Partners[i].KeyNo+'.html">'+data.Result.Partners[i].StockName+'</a></td>';
                                }else{
                                    html += '<td><a onclick="" target="_blank" href="/firm_'+data.Result.Partners[i].KeyNo+'.shtml">'+data.Result.Partners[i].StockName+'</a></td>';
                                }
                            }else{
                                if(data.Result.Partners[i].StockName.length>3){
                                    html += "<td>"+data.Result.Partners[i].StockName+"</td>";
                                }else{
                                    html += '<td><a onclick="" target="_blank" href="/people?name='+encodeURI(data.Result.Partners[i].StockName)+'&keyno='+keyNo+'">'+data.Result.Partners[i].StockName+'</a></td>';
                                }
                            }
                            html += "<td>"+(data.Result.Partners[i].StockType || "-")+"</td>";
                            html += "</tr>";
                        }
                        html+='</table>'

                        companyDetail.find('.gudong-list').html(html);


                    }else {
                        companyDetail.find('.gudong-list').html(noData);
                    }

                    //投资
                    if(data.Result.touziList && data.Result.touziList.length>0){

                        var html = '<table class="ntable">';
                        html += "<thead><tr><th  style='text-align: left'>名称</th></tr></thead>";
                        for(var i=0; i<data.Result.touziList.length; i++){
                            html += "<tr>";
                            html += "<td><a onclick='' href='/firm_"+data.Result.touziList[i].KeyNo+".shtml' target='_blank'>"+data.Result.touziList[i].Name+"</a></td>";
                            html += "</tr>";
                        }
                        html+='</table>';
                        companyDetail.find('.touzi-list').html(html);
                    }else {
                        companyDetail.find('.touzi-list').html(noData);
                    }

                    //成员
                    if(data.Result.Employees && data.Result.Employees.length>0){
                        var html = '<table class="ntable">';
                        html += "<thead><tr><th  style='text-align: left'>名称</th><th>类型</th></tr></thead>";
                        for(var i=0; i<data.Result.Employees.length; i++){
                            html += "<tr>";
                            if(data.Result.Employees[i].KeyNo && data.Result.Employees[i].KeyNo[0]=='p'){
                                html += '<td><a onclick="" target="_blank" href="/pl_'+data.Result.Employees[i].KeyNo+'.html">'+data.Result.Employees[i].Name+'</a></td>';
                            }else{
                                html += '<td><a onclick="" target="_blank" href="/people?name='+encodeURI(data.Result.Employees[i].Name)+'&keyno='+keyNo+'">'+data.Result.Employees[i].Name+'</a></td>';
                            }
                            html += "<td>"+(data.Result.Employees[i].Job||"-")+"</td>";
                            html += "</tr>";
                        }
                        html+='</table>';
                        companyDetail.find('.member-list').html(html);

                    }else {
                        companyDetail.find('.member-list').html(noData);
                    }

                    $("#company-detail").fadeIn();
                    companyDetail.find('.mao-tab-content').slimScroll({
                        wheelStep: 1
                    });
                },
                error:function(data){
                    console.log(data);
                }
            });
        }
    }

    /*ie兼容*/
    var isIE = (!!window.ActiveXObject || "ActiveXObject" in window);
    if(isIE){
        $("#NameBar").css({'width':'270px'});
    }
</script>

<div style="display:none;position: fixed; left: 0px; top: 0px; width: 100%; height: 100%; cursor: move; opacity: 0; background: rgb(255, 255, 255);"></div>
</body>
</html>